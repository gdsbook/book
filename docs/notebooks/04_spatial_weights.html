

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Spatial Weights &#8212; Geographic Data Science with Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-146598819-1"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-146598819-1');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/04_spatial_weights';</script>
    <link rel="canonical" href="https://geographicdata.science/book/notebooks/04_spatial_weights.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Overview" href="../intro_part_ii.html" />
    <link rel="prev" title="Spatial Data" href="03_spatial_data.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Home
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="00_toc.html">Table of Contents</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part I - Building Blocks</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_part_i.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_geo_thinking.html">Geographic Thinking for Data Scientists</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_geospatial_computational_environment.html">Computational Tools for Geographic Data Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_spatial_data.html">Spatial Data</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spatial Weights</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part II - Spatial Data Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_part_ii.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_choropleth.html">Choropleth Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_spatial_autocorrelation.html">Global Spatial Autocorrelation</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_local_autocorrelation.html">Local Spatial Autocorrelation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_point_pattern_analysis.html">Point Pattern Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part III - Advanced Topics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_part_iii.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_spatial_inequality.html">Spatial Inequality Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_clustering_and_regionalization.html">Clustering and Regionalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="11_regression.html">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_feature_engineering.html">Spatial Feature Engineering</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Endmatter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data/README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/airbnb/regression_cleaning.html">AirBnb</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/airports/airports_cleaning.html">Airports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/brexit/brexit_cleaning.html">Brexit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/countries/countries_cleaning.html">Countries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/ghsl/build_ghsl_extract.html">GHSL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/h3_grid/build_sd_h3_grid.html">H3 Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/mexico/README.html">Mexico</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/nasadem/build_nasadem_sd.html">NASA DEM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/sandiego/sandiego_tracts_cleaning.html">San Diego Tracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/texas/README.html">Texas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/tokyo/tokyo_cleaning.html">Tokyo Photographs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/us_county_income/README.html">US County Income 1969-2017</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/gdsbook/book/master?urlpath=lab/tree/notebooks/04_spatial_weights.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/gdsbook/book/blob/master/notebooks/04_spatial_weights.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/04_spatial_weights.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spatial Weights</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contiguity-weights">Contiguity weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-weights-from-real-world-geographic-tables">Spatial weights from real-world geographic tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-weights-from-surfaces">Spatial weights from surfaces</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-based-weights">Distance based weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k-nearest-neighbor-weights">K-nearest neighbor weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-weights">Kernel weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-bands-and-hybrid-weights">Distance bands and hybrid Weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#great-circle-distances">Great circle distances</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#block-weights">Block weights</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-operations-on-weights">Set operations on weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-connecting-disconnected-observations">Editing/connecting disconnected observations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-union-of-matrices">Using the <code class="docutils literal notranslate"><span class="pre">union</span></code> of matrices</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-weight-set-operations">Visualizing weight set operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-boundary-detection">Use case: boundary detection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next steps</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spatial-weights">
<h1>Spatial Weights<a class="headerlink" href="#spatial-weights" title="Permalink to this headline">#</a></h1>
<p>“Spatial weights” are one way to represent graphs in geographic data science and spatial statistics. They are widely used constructs that represent geographic relationships between the observational units in a spatially referenced dataset. Implicitly, spatial weights connect objects in a geographic table to one another using the spatial relationships between them. By expressing the notion of geographical proximity or connectedness, spatial weights are the main mechanism through which the spatial relationships in geographical data is brought to bear in the subsequent analysis.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h2>
<p>Spatial weights often express our knowledge about spatial relationships.
For example, proximity and adjacency are common spatial questions: <em>What neighborhoods are you surrounded by? How many gas stations are within 5 miles of my stalled car?</em>
These are spatial questions that target specific information about the spatial configuration of a specific target (“a neighborhood,” “my stalled car”) and geographically connected relevant sites (“adjacent neighborhoods”, “nearby gas stations”). For us to use this information in statistical analysis, it’s often necessary to compute these relationships between all pairs of observations. This means that, for many applications in geographic data science, we are building a <em>topology</em>—a mathematical structure that expresses the connectivity between observations—that we can use to examine the data. Spatial weights matrices express this topology, letting us embed all of our observations in space together, rather than asking and answering single questions about features nearby a unit.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">contextily</span>
<span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">import</span> <span class="nn">rioxarray</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">pysal.lib</span> <span class="kn">import</span> <span class="n">cg</span> <span class="k">as</span> <span class="n">geometry</span>
</pre></div>
</div>
</div>
</div>
<p>Since they provide a way to represent these spatial relationships, spatial weights are widely used throughout spatial and geographic data science.
In this chapter, we first consider different approaches to construct spatial weights, distinguishing between those based on contiguity/adjacency relations from weights obtained from distance based relationships. We then discuss the case of hybrid weights which combine one or more spatial operations in deriving the neighbor relationships between observations. We illustrate all of these concepts through the spatial weights class in <code class="docutils literal notranslate"><span class="pre">pysal</span></code>, which provides a rich set of methods and characteristics for spatial weights and it is stored under the <code class="docutils literal notranslate"><span class="pre">weights</span></code> sub-module:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysal.lib</span> <span class="kn">import</span> <span class="n">weights</span>
</pre></div>
</div>
</div>
</div>
<p>We also demonstrate its set-theoretic functionality, which permits the derivation of weights through the application of set operations. Throughout the chapter, we discuss common file formats used to store spatial weights of different types, and we include visual discussion of spatial weights, making these sometimes abstract constructs more intuitive.</p>
</section>
<section id="contiguity-weights">
<h2>Contiguity weights<a class="headerlink" href="#contiguity-weights" title="Permalink to this headline">#</a></h2>
<p>A contiguous pair of spatial objects are those that share a common border. At first
glance, this seems straightforward. However, in practice this turns out to be
more complicated. The first complication is that there are different ways that objects can “share a common border”. Let’s start with the example of a three-by-three grid. We can create it as a geo-table from scratch:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get points in a grid</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span>
<span class="c1"># Set up store</span>
<span class="n">polys</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># Generate polygons</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">ys</span><span class="o">.</span><span class="n">flatten</span><span class="p">()):</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="n">polys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">poly</span><span class="p">)</span>
<span class="c1"># Convert to GeoSeries</span>
<span class="n">polys</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoSeries</span><span class="p">(</span><span class="n">polys</span><span class="p">)</span>
<span class="n">gdf</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">polys</span><span class="p">,</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;P-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">polys</span><span class="p">))],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>which results in the grid shown in the following figure.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot grid geotable</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>

<span class="c1"># Loop over each cell and add the text</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">],</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]],</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>

<span class="c1"># Remove axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/42967d761bd224cd17b8a5ae6559fd2ab39906d13efcce560a8211a9376c2fce.png" src="../_images/42967d761bd224cd17b8a5ae6559fd2ab39906d13efcce560a8211a9376c2fce.png" />
</div>
</div>
<p>A common way to express contiguity/adjacency relationships arises from an analogy to the legal moves that different chess pieces can make. <em>Rook</em> contiguity requires that the pair of polygons in
question share an <em>edge</em>. According to this definition, polygon <span class="math notranslate nohighlight">\(0\)</span> would be a Rook neighbor of <span class="math notranslate nohighlight">\(1\)</span> and <span class="math notranslate nohighlight">\(3\)</span>, while <span class="math notranslate nohighlight">\(1\)</span> would be a Rook neighbor with <span class="math notranslate nohighlight">\(0\)</span>, <span class="math notranslate nohighlight">\(2\)</span>, and <span class="math notranslate nohighlight">\(4\)</span>. Applying this rule to all nine polygons we can model our neighbor relations as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a rook contiguity matrix from a regular 3x3</span>
<span class="c1"># lattice stored in a geo-table</span>
<span class="n">wr</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">contiguity</span><span class="o">.</span><span class="n">Rook</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note the pattern we use to build the <code class="docutils literal notranslate"><span class="pre">w</span></code> object, which is similar across the library: we specify the criterium we want for the weights (<code class="docutils literal notranslate"><span class="pre">weights.contiguity.Rook</span></code>) and then the “constructor” we will use (<code class="docutils literal notranslate"><span class="pre">from_dataframe</span></code>). We can visualize the result plotted on top of the same grid of labeled polygons, using red dotted lines to represent the edges between a pair of nodes (polygon centroids in this case). We can see this in the following figure.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">))</span>
<span class="c1"># Plot grid</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># Loop over each cell and add the text</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">],</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]],</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1"># Plot weights connectivity</span>
<span class="n">wr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># Remove axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/faa8527bb455837a6475353c957c0571821d5f4c7f2de2fd5a5da78ce5fe5cee.png" src="../_images/faa8527bb455837a6475353c957c0571821d5f4c7f2de2fd5a5da78ce5fe5cee.png" />
</div>
</div>
<p>The  <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> attribute of our <code class="docutils literal notranslate"><span class="pre">pysal</span></code> <span class="math notranslate nohighlight">\(W\)</span> object encodes the neighbor
relationships by expressing the <em>focal</em> observation on the left (in the <code class="docutils literal notranslate"><span class="pre">key</span></code> of the dictionary), and expressing the <em>neighbors</em> to the <em>focal</em> in the list on the right (in the <code class="docutils literal notranslate"><span class="pre">value</span></code> of the dictionary). This representation has computational advantages, as it exploits
the sparse nature of contiguity weights matrices by recording only non-zero weights:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wr</span><span class="o">.</span><span class="n">neighbors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0: [1, 3],
 1: [0, 2, 4],
 2: [1, 5],
 3: [0, 4, 6],
 4: [1, 3, 5, 7],
 5: [8, 2, 4],
 6: [3, 7],
 7: [8, 4, 6],
 8: [5, 7]}
</pre></div>
</div>
</div>
</div>
<p>More specifically, knowing
that the neighbors of polygon <span class="math notranslate nohighlight">\(0\)</span> are <span class="math notranslate nohighlight">\(3\)</span> and <span class="math notranslate nohighlight">\(1\)</span> implies that polygons <span class="math notranslate nohighlight">\(2, 4,
5, 6, 7, 8\)</span> are not Rook neighbors of 0. As such, there is no reason to store
the “non-neighbor” information and this results in significant reductions in
memory requirements. However, it is possible to create the fully dense, matrix
representation if needed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="o">*</span><span class="n">wr</span><span class="o">.</span><span class="n">full</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As you can see from the matrix above, most entries are zero. In fact out of all of the possible <span class="math notranslate nohighlight">\(9^2=81\)</span> linkages that there could be in this matrix, there are only 24 non-zero entries:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wr</span><span class="o">.</span><span class="n">nonzero</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>24
</pre></div>
</div>
</div>
</div>
<p>Thus, we can save a significant amount of memory and lose no information using these sparse representations, which only record the non-zero values.</p>
<p>More generally, the spatial weights for our 3-by-3 grid can be represented as a matrix that has 9 rows and 9 columns, matching the number of polygons <span class="math notranslate nohighlight">\((n=9)\)</span>. An important thing to note is that geography has more than one dimension. When compared to common representations of relationships <em>in time</em> used in data science, using information about spatial relationships can be more complex: spatial relationships are bi-directional, while temporal relationships are unidirectional. Further complicating things, the ordering of the observations in the weights matrix is arbitrary. The first row is not first for a specific mathematical reason; it just happens to be the first entry in the input. Here we use the alphanumeric ordering of the unit identifiers to match a polygon with a row or column of the matrix, but any arbitrary rule could be followed and the weights matrix would look different. The graph, however, would be isomorphic and retain the mapping of relationships.</p>
<p>Spatial weights matrices may look familiar to those acquainted with social
networks and graph theory in which <strong>adjacency</strong> matrices play a central role in
expressing connectivity between nodes. Indeed, spatial weights matrices can be
understood as a graph adjacency matrix where each observation is a node and
the spatial weight assigned between a pair represents the weight of the edge on
a graph connecting the arcs. Sometimes, this is called the <strong>dual graph</strong> of the input geographic data. This is advantageous, as geographic data science can
borrow from the rich graph theory literature. At the same time, spatial
data has numerous distinguishing characteristics that necessitate the
development of specialized procedures and concepts in the handling of spatial
weights. This chapter will cover many of these features.</p>
<p>But for now, let’s get back to the Rook contiguity graph. A close inspection reveals that this criterion actually places
a restriction on the spatial relation. More specifically, polygons <span class="math notranslate nohighlight">\(0\)</span> and <span class="math notranslate nohighlight">\(5\)</span>
are not Rook neighbors, but they do in fact share a common border. However, in
this instance the sharing is due to a common <em>vertex</em> rather than a shared
<em>edge</em>. If we wanted them to be considered as neighbours, we can switch to the more inclusive notion of <em>Queen</em> contiguity, which
requires the pair of polygons to only share one or more <em>vertices</em>. We can create the
neighbor relations for this same configuration as follows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build a queen contiguity matrix from a regular 3x3</span>
<span class="c1"># lattice stored in a geo-table</span>
<span class="n">wq</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">contiguity</span><span class="o">.</span><span class="n">Queen</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
<span class="n">wq</span><span class="o">.</span><span class="n">neighbors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0: [1, 3, 4],
 1: [0, 2, 3, 4, 5],
 2: [1, 4, 5],
 3: [0, 1, 4, 6, 7],
 4: [0, 1, 2, 3, 5, 6, 7, 8],
 5: [1, 2, 4, 7, 8],
 6: [3, 4, 7],
 7: [3, 4, 5, 6, 8],
 8: [4, 5, 7]}
</pre></div>
</div>
</div>
</div>
<p>In addition to this neighbors representation, we can also express the graph visually, as done before. This is shown in the following figure.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">))</span>
<span class="c1"># Plot grid</span>
<span class="n">gdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># Loop over each cell and add the text</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">],</span>
    <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mf">0.25</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">polys</span><span class="p">],</span>
    <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gdf</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]],</span>
<span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">y</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
        <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span>
    <span class="p">)</span>
<span class="c1"># Plot weights connectivity</span>
<span class="n">wq</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gdf</span><span class="p">,</span> <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># Remove axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/7758306e8aff12a6d52c33cd4955432cb6ba7016ba4fe512476d13dc91e4a986.png" src="../_images/7758306e8aff12a6d52c33cd4955432cb6ba7016ba4fe512476d13dc91e4a986.png" />
</div>
</div>
<p>By using <code class="docutils literal notranslate"><span class="pre">Contiguity.Queen</span></code> rather than <code class="docutils literal notranslate"><span class="pre">Contiguity.Rook</span></code>, we consider observations that share a vertex to be neighbors. The result is that the neighbors of <span class="math notranslate nohighlight">\(0\)</span> now include <span class="math notranslate nohighlight">\(4\)</span> along with <span class="math notranslate nohighlight">\(3\)</span> and <span class="math notranslate nohighlight">\(1\)</span>.</p>
<p>Akin to how the <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> dictionary encodes the contiguity relations, the <code class="docutils literal notranslate"><span class="pre">weights</span></code> dictionary encodes the strength of the link connecting the focal to each neighbor. For contiguity
weights, observations are usually either considered “linked” or “not linked,” so the resulting weights matrix is binary. As in any <code class="docutils literal notranslate"><span class="pre">pysal</span></code> <code class="docutils literal notranslate"><span class="pre">W</span></code> object, the actual weight values are contained in the <code class="docutils literal notranslate"><span class="pre">weights</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wq</span><span class="o">.</span><span class="n">weights</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0: [1.0, 1.0, 1.0],
 1: [1.0, 1.0, 1.0, 1.0, 1.0],
 2: [1.0, 1.0, 1.0],
 3: [1.0, 1.0, 1.0, 1.0, 1.0],
 4: [1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0],
 5: [1.0, 1.0, 1.0, 1.0, 1.0],
 6: [1.0, 1.0, 1.0],
 7: [1.0, 1.0, 1.0, 1.0, 1.0],
 8: [1.0, 1.0, 1.0]}
</pre></div>
</div>
</div>
</div>
<p>Similar to the <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> attribute, the <code class="docutils literal notranslate"><span class="pre">weights</span></code> object is a Python
dictionary that only stores the non-zero weights. Although the weights for a
given observations neighbors are all the same value for contiguity weights, it
is important to note that the <code class="docutils literal notranslate"><span class="pre">weights</span></code> and <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> are aligned with one another; for each observation, its first neighbor in <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> has the first weight in its <code class="docutils literal notranslate"><span class="pre">weights</span></code> entry. This will be important when we examine distance based weights further
on, when observations will have different weights.</p>
<p>In addition to the <code class="docutils literal notranslate"><span class="pre">neighbor</span></code> and <code class="docutils literal notranslate"><span class="pre">weights</span></code> attributes, the <code class="docutils literal notranslate"><span class="pre">w</span></code> object has a
large number of other attributes and methods that can be useful. The
<code class="docutils literal notranslate"><span class="pre">cardinalities</span></code> attribute reports the number of neighbors for each observation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wq</span><span class="o">.</span><span class="n">cardinalities</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0: 3, 1: 5, 2: 3, 3: 5, 4: 8, 5: 5, 6: 3, 7: 5, 8: 3}
</pre></div>
</div>
</div>
</div>
<p>The related <code class="docutils literal notranslate"><span class="pre">histogram</span></code> attribute provides an overview of the distribution of
these cardinalities:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wq</span><span class="o">.</span><span class="n">histogram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(3, 4), (4, 0), (5, 4), (6, 0), (7, 0), (8, 1)]
</pre></div>
</div>
</div>
</div>
<p>We can obtain a quick visual representation by converting the cardinalities
into a <code class="docutils literal notranslate"><span class="pre">pandas.Series</span></code> and creating a histogram:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">wq</span><span class="o">.</span><span class="n">cardinalities</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3aeb88b6a69ba9348ccbaa0606491697e0575293145aa55dc499b03cfb234308.png" src="../_images/3aeb88b6a69ba9348ccbaa0606491697e0575293145aa55dc499b03cfb234308.png" />
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cardinalities</span></code> and <code class="docutils literal notranslate"><span class="pre">histogram</span></code> attributes help quickly spot asymmetries in
the number of neighbors. This, as we will see later in the book, is relevant
when using spatial weights in other analytical techniques (e.g.,
spatial autocorrelation analysis or spatial regression). Here we see that there are four corner
observations with three neighbors, four edge observations with five neighbors,
and the one central observation has eight neighbors. There are also no
observations with four, six, or seven neighbors.</p>
<p>By convention, an ordered pair of contiguous observations constitutes a <em>join</em>
represented by a non-zero weight in a <span class="math notranslate nohighlight">\(W\)</span>. The attribute <code class="docutils literal notranslate"><span class="pre">s0</span></code> records the number
of joins.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wq</span><span class="o">.</span><span class="n">s0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>40.0
</pre></div>
</div>
</div>
</div>
<p>Thus, the Queen weights here have just under twice the number of joins in this case.
The <code class="docutils literal notranslate"><span class="pre">pct_nonzero</span></code> attribute provides a measure of the density (compliment of
sparsity) of the spatial weights matrix (if we had it stored explicitly, which
we don’t):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wq</span><span class="o">.</span><span class="n">pct_nonzero</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>49.382716049382715
</pre></div>
</div>
</div>
</div>
<p>which is equal to <span class="math notranslate nohighlight">\(100 \times (\texttt{w.s0} / \texttt{w.n}^2)\)</span>.</p>
<section id="spatial-weights-from-real-world-geographic-tables">
<h3>Spatial weights from real-world geographic tables<a class="headerlink" href="#spatial-weights-from-real-world-geographic-tables" title="Permalink to this headline">#</a></h3>
<p>The regular lattice map encountered above helps us to understand the logic and
properties of <code class="docutils literal notranslate"><span class="pre">pysal</span></code>’s spatial weights class. However, the artificial nature of
that geography is of limited relevance to real world research problems.
<code class="docutils literal notranslate"><span class="pre">pysal</span></code> supports the construction of spatial weights objects from a
number of commonly used spatial data formats. Here we demonstrate this
functionality for the case of census tracts in San Diego, California. Most spatial
data formats, such as shapefiles, are non-topological in that they encode the
polygons as a collection of vertices defining the edges of the geometry’s
boundary. No information about the neighbor relations is explicitly encoded, so we
must construct it ourselves. Under the hood, <code class="docutils literal notranslate"><span class="pre">pysal</span></code> uses efficient spatial indexing
structures to extract these.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">san_diego_tracts</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span>
    <span class="s2">&quot;../data/sandiego/sandiego_tracts.gpkg&quot;</span>
<span class="p">)</span>
<span class="n">w_queen</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">contiguity</span><span class="o">.</span><span class="n">Queen</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">san_diego_tracts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Like before, we can visualize the adjacency relationships, but they are much more difficult to see without showing a closer detail. This higher level of detail is shown in the right pane of the plot.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot tract geography</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="c1"># Plot graph connections</span>
    <span class="n">w_queen</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">san_diego_tracts</span><span class="p">,</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">node_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Remove the axis</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mi">13040000</span><span class="p">,</span> <span class="o">-</span><span class="mi">13020000</span><span class="p">,</span> <span class="mi">3850000</span><span class="p">,</span> <span class="mi">3860000</span><span class="p">]);</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/1aae5b4e0ec40b67a0eef0099a3f0b353b17bcb1a53549df6d5f760187077f86.png" src="../_images/1aae5b4e0ec40b67a0eef0099a3f0b353b17bcb1a53549df6d5f760187077f86.png" />
</div>
</div>
<p>The weights object for San Diego tracts have the same attributes and methods as
we encountered with our artificial layout above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">w_queen</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">w_queen</span><span class="o">.</span><span class="n">pct_nonzero</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>628
1.018296888311899
</pre></div>
</div>
</div>
</div>
<p>First, we have a larger number of spatial units. The spatial weights are
also much sparser for the tracts than what we saw for our smaller toy
grid. Moreover, the cardinalities have a radically different distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">w_queen</span><span class="o">.</span><span class="n">cardinalities</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a30155e445ef5c36b27d72fbe83b90230a89d617ede3b8f8dece39820bcf907b.png" src="../_images/a30155e445ef5c36b27d72fbe83b90230a89d617ede3b8f8dece39820bcf907b.png" />
</div>
</div>
<p>As the minimum number of neighbors is 1, while there is one polygon with 29
Queen neighbors. The most common number of neighbors is 6. For comparison, we
can also plot the equivalent for Rook weights of the same dataframe:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_rook</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">contiguity</span><span class="o">.</span><span class="n">Rook</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">san_diego_tracts</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">w_rook</span><span class="o">.</span><span class="n">pct_nonzero</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">w_rook</span><span class="o">.</span><span class="n">cardinalities</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.8722463385938578
</pre></div>
</div>
<img alt="../_images/9146a00787abd6b4b245d71641ab4b1574521f95e4eda48be049bb5be0d52b7f.png" src="../_images/9146a00787abd6b4b245d71641ab4b1574521f95e4eda48be049bb5be0d52b7f.png" />
</div>
</div>
<p>The cardinality histogram shifts downward due to the increasing sparsity of the
weights for the rook case relative to the Queen criterion. Conceptually, this makes sense: all Rook neighbors are also Queen neighbors, since Queen includes neighbors that share an edge; but, not all Queen neighbors are Rook neighbors, since some Queen neighbors only share a point on their boundaries in common.</p>
<p>The example above shows how the notion of contiguity, although more
straightforward in the case of a grid, can be naturally extended beyond the
particular case of a regular lattice. The principle to keep in mind is that we
consider contiguous (and hence call neighbors) observations which share part
of their border coordinates. In the Queen case, a single point is enough to make
the join. For Rook neighbors, we require a join to consist of one or more
shared edges. This distinction is less relevant in the real world than
it appears in the grid example above. In any case, there are some cases
where this distinction can matter and it is useful to be familiar with the
differences between the two approaches.</p>
</section>
<section id="spatial-weights-from-surfaces">
<h3>Spatial weights from surfaces<a class="headerlink" href="#spatial-weights-from-surfaces" title="Permalink to this headline">#</a></h3>
<p>Most often, we will use spatial weights as a way to connect features stored in rows of a geographic table. A more niche application is spatial weights derived from surfaces. Recalling from <a class="reference internal" href="01_geo_thinking.html"><span class="doc std std-doc">Chapter 1</span></a>, the boundary between which phenomena get stored as tables and which ones as surfaces is blurring. This means that analytics that were traditionally developed for tables are increasingly being used on surfaces. Here, we illustrate how one can build spatial weights from data stored in surfaces. As we will see later in the book, this widens the range of analytics that we can apply to surface data.</p>
<p>For the illustration, we will use a surface that contains population counts for the Sao Paulo region in Brazil:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sao_paulo</span> <span class="o">=</span> <span class="n">rioxarray</span><span class="o">.</span><span class="n">open_rasterio</span><span class="p">(</span><span class="s2">&quot;../data/ghsl/ghsl_sao_paulo.tif&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>From version 2.4 onwards, <code class="docutils literal notranslate"><span class="pre">pysal</span></code> added support to build spatial weights from <code class="docutils literal notranslate"><span class="pre">xarray.DataArray</span></code> objects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_sao_paulo</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">contiguity</span><span class="o">.</span><span class="n">Queen</span><span class="o">.</span><span class="n">from_xarray</span><span class="p">(</span><span class="n">sao_paulo</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Although the internals differ quite a bit, once built, the objects are a sparse version of the same object that is constructed from a geographic table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_sao_paulo</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;libpysal.weights.weights.WSP at 0x7f7a0f1e30a0&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="distance-based-weights">
<h2>Distance based weights<a class="headerlink" href="#distance-based-weights" title="Permalink to this headline">#</a></h2>
<p>In addition to contiguity, we can also define neighbor relations as a function of
the distance separating spatial observations. Usually, this means that a matrix expressing the distances between all pairs of observations are required. These are then provided to a <strong>kernel</strong> function which uses the proximity information to model proximity as a smooth function of distance. <code class="docutils literal notranslate"><span class="pre">pysal</span></code> implements a family of
distance functions. Here we illustrate a selection beginning with the notion
of <em>nearest neighbor</em> weights.</p>
<section id="k-nearest-neighbor-weights">
<h3>K-nearest neighbor weights<a class="headerlink" href="#k-nearest-neighbor-weights" title="Permalink to this headline">#</a></h3>
<p>The first type of distance based weights defines the neighbor set of a
particular observation as containing its nearest <span class="math notranslate nohighlight">\(k\)</span> observations, where the
user specifies the value of <span class="math notranslate nohighlight">\(k\)</span>. To illustrate this for the San Diego
tracts, we take <span class="math notranslate nohighlight">\(k=4\)</span>. This still leaves the issue of how to measure the distance
between these polygon objects, however. To do so we develop a representative
point for each of the polygons using the centroid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wk4</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">san_diego_tracts</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The centroids are calculated from
the spatial information stored in the <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code> as we have seen before. Since we are dealing with
polygons in this case, <code class="docutils literal notranslate"><span class="pre">pysal</span></code> uses inter-centroid distances to determine the
<span class="math notranslate nohighlight">\(k\)</span> nearest observations to each polygon.</p>
<p>The k-nearest neighbor weights displays no island problem, that is <em>everyone</em> has at least one neighbor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wk4</span><span class="o">.</span><span class="n">islands</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[]
</pre></div>
</div>
</div>
</div>
<p>This is the same for the contiguity case above but, in the case of k-nearest neighbor weights, this is by construction. Examination of the cardinality histogram for the k-nearest neighbor weights shows another built-in feature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wk4</span><span class="o">.</span><span class="n">histogram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(4, 628)]
</pre></div>
</div>
</div>
</div>
<p>Everyone has the same number of neighbors. In some cases, this is not an issue but a desired feature. In
other contexts, however, this characteristic of k-nearest neighbor weights can be undesirable.
In such situations, we can turn to other types of distance-based weights.</p>
</section>
<section id="kernel-weights">
<h3>Kernel weights<a class="headerlink" href="#kernel-weights" title="Permalink to this headline">#</a></h3>
<p>The k-nearest neighbor rule assigns binary values to the weights for neighboring observations.
<code class="docutils literal notranslate"><span class="pre">pysal</span></code> also supports continuously valued weights to reflect Tobler’s first law
<span id="id1">[<a class="reference internal" href="references.html#id54" title="Waldo R Tobler. A computer movie simulating urban growth in the Detroit region. Economic geography, 46(sup1):234–240, 1970.">Tob70</a>]</span> in a more direct way: observations that are close to a unit have larger
weights than more distant observations.</p>
<p>Kernel weights are one of the most commonly-used kinds of distance weights. They
reflect the case where similarity/spatial proximity is assumed or expected to
decay with distance. The essence of kernel weights is that the weight between
observations <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> is based on their distance, but it is further modulated by
a kernel function with certain properties. <code class="docutils literal notranslate"><span class="pre">pysal</span></code> implements several kernels.
All of them share the properties of distance decay (thus encoding Tobler’s First
Law), but may decay at different rates with respect to distance.</p>
<p>As a computational note, it is worth mentioning that many of these distance-based decay functions require more resources than the contiguity weights or K-nearest neighbor weights discussed above. This is because the contiguity and k-nearest neighbor structures embed simple assumptions about how shapes relate in space, while kernel functions relax several of those assumptions. Thus, they provide more flexibility at the expense of computation.</p>
<p>The simplest way to compute Kernel weights in <code class="docutils literal notranslate"><span class="pre">pysal</span></code> involves a single function
call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_kernel</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">gdf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Like k-nearest neighbor weights, the Kernel weights are based on distances between observations. By default, if the input data is an areal unit, we use a central representative point (like the centroid) for that polygon.
The value of the weights will be a function of two main options for
kernel weights: choice of kernel function and bandwidth. The
former controls how distance between <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(j\)</span> is “modulated” to produce
the weight that goes in <span class="math notranslate nohighlight">\(w_{ij}\)</span>. In this respect, <code class="docutils literal notranslate"><span class="pre">pysal</span></code> offers a large number
of functions that determine the shape of the distance
decay function. The bandwidth specifies the distance from each focal unit over which
the kernel function is applied. For observations separated by distances larger
than the bandwidth, the weights are set to zero.</p>
<p>The default values for kernels are to use a triangular kernel with a bandwidth distance
equal to the maximum knn=2 distance
for all observations. The latter implies a so-called fixed bandwidth where all
observations use the same distance for the cut-off. We can inspect this from
the generated <code class="docutils literal notranslate"><span class="pre">W</span></code> object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_kernel</span><span class="o">.</span><span class="n">function</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;triangular&#39;
</pre></div>
</div>
</div>
</div>
<p>for the kernel function, and:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show the first five values of bandwidths</span>
<span class="n">w_kernel</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1.0000001],
       [1.0000001],
       [1.0000001],
       [1.0000001],
       [1.0000001]])
</pre></div>
</div>
</div>
</div>
<p>For the bandwidth applied to each observation.</p>
<p>Although simple, a fixed bandwidth is not always the best choice. For example,
in cases where the density of the observations varies over the study region,
using the same threshold anywhere will result in regions with a high density
of neighbors while others with observations very sparsely connected. In these
situations, an <em>adaptive</em> bandwidth -one which varies by observation and its
characteristics- can be preferred.</p>
<p>Adaptive bandwidths are picked again using a K-nearest neighbor rule. A bandwidth for each observation is chosen such that, once the <span class="math notranslate nohighlight">\(k\)</span>-nearest observation is considered, all the remaining observations have zero weight. To illustrate it, we will use a subset of tracts in our San Diego dataset. First, visualizing the centroids, we can see that they are not exactly regularly-spaced, although others do nearly fall into a regular spacing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create subset of tracts</span>
<span class="n">sub_30</span> <span class="o">=</span> <span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;sub_30 == True&quot;</span><span class="p">)</span>
<span class="c1"># Plot polygons</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">sub_30</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
<span class="c1"># Create and plot centroids</span>
<span class="n">sub_30</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="c1"># Remove axis</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b29dbdebb3df3c2227876ee48f3dba38d21774945080caf5464b6704057f743f.png" src="../_images/b29dbdebb3df3c2227876ee48f3dba38d21774945080caf5464b6704057f743f.png" />
</div>
</div>
<p>If we now build a weights object with adaptive bandwidth (<code class="docutils literal notranslate"><span class="pre">fixed=False</span></code>), the values for bandwidth differ:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build weights with adaptive bandwidth</span>
<span class="n">w_adaptive</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">Kernel</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
    <span class="n">sub_30</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">15</span>
<span class="p">)</span>
<span class="c1"># Print first five bandwidth values</span>
<span class="n">w_adaptive</span><span class="o">.</span><span class="n">bandwidth</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[7065.74020822],
       [3577.22591841],
       [2989.74807871],
       [2891.46196945],
       [3965.08354232]])
</pre></div>
</div>
</div>
</div>
<p>And, we can visualize what these kernels look like on the map, too, by focusing on an individual unit and showing how the distance decay attenuates the weight by grabbing the corresponding row of the full kernel matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create full matrix version of weights</span>
<span class="n">full_matrix</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="n">w_adaptive</span><span class="o">.</span><span class="n">full</span><span class="p">()</span>
<span class="c1"># Set up figure with two subplots in a row</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
    <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">subplot_kw</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># Append weights for first polygon and plot on first subplot</span>
<span class="n">sub_30</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">weight_0</span><span class="o">=</span><span class="n">full_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="s2">&quot;weight_0&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Append weights for 18th polygon and plot on first subplot</span>
<span class="n">sub_30</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">weight_18</span><span class="o">=</span><span class="n">full_matrix</span><span class="p">[</span><span class="mi">17</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="s2">&quot;weight_18&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Add centroid of focal tracts</span>
<span class="n">sub_30</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Focal Tract&quot;</span>
<span class="p">)</span>
<span class="n">sub_30</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">17</span><span class="p">],</span> <span class="p">:]</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Focal Tract&quot;</span>
<span class="p">)</span>
<span class="c1"># Add titles</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Kernel centered on first tract&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Kernel centered on 18th tract&quot;</span><span class="p">)</span>
<span class="c1"># Remove axis</span>
<span class="p">[</span><span class="n">ax_</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax_</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">]</span>
<span class="c1"># Add legend</span>
<span class="p">[</span><span class="n">ax_</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax_</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">];</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9521bcba155d41ed6c69e55851145e600ba1dd629c25e24fe8f13d35c435c1e8.png" src="../_images/9521bcba155d41ed6c69e55851145e600ba1dd629c25e24fe8f13d35c435c1e8.png" />
</div>
</div>
<p>What the kernel looks like can be strongly affected by the structure of spatial proximity, so any part of the map can look quite different from any other part of the map. By imposing a clear distance decay over several of the neighbors of each observation,
kernel weights incorporate Tobler’s law explicitly. Often, this comes at the cost of
increased memory requirements, as every single pair of observations within the
bandwidth distance is considered:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_kernel</span><span class="o">.</span><span class="n">pct_nonzero</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>40.74074074074074
</pre></div>
</div>
</div>
</div>
<p>In many instances, this may be at odds with the nature of the spatial
interactions at hand, which operate over a more limited range of distance. In
these cases, expanding the neighborhood set beyond might lead us to consider
interactions which do not take place, or are inconsequential. Thus, for
both substantive and computational reasons, it might make sense to further
limit the range, keeping impacts hyper-local.</p>
</section>
<section id="distance-bands-and-hybrid-weights">
<h3>Distance bands and hybrid Weights<a class="headerlink" href="#distance-bands-and-hybrid-weights" title="Permalink to this headline">#</a></h3>
<p>In some contexts, it makes sense to draw a circle around each observation and
consider as neighbors every other observation that falls within the circle.
In the GIS terminology, this is akin to drawing a buffer around each point and
performing a point-in-polygon operation that determines whether the
other observations are within the buffer. If they are, they are assigned a
weight of one in the spatial weights matrix; if not they receive a zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_bdb</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">DistanceBand</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
    <span class="n">gdf</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This creates a binary distance weights where every other observation within
a distance of 1.5 is considered neighbor.</p>
<p>Distance band weights can also be continuously weighted. These could be seen as a kind of “censored” kernel, where the kernel function is applied only within a pre-specified distance. For example, let us calculate the DistanceBand weights that use inverse distance
weights up to a certain threshold and then truncate the weights to zero for
everyone else. For this example we will return to the small lattice example
covered in the beginning:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_hy</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">DistanceBand</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
    <span class="n">gdf</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">binary</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We apply a threshold of 1.5 for this illustration. <code class="docutils literal notranslate"><span class="pre">pysal</span></code> truncates continuous
weights at this distance. It is important to keep in mind that the threshold
distance must use the same units of distance as the units used to define the
matrix.</p>
<p>To see the difference, consider polygon 4, in the middle of the grid. The Queen set of weights includes eight neighbors with a uniform weight of one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wq</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]
</pre></div>
</div>
</div>
</div>
<p>while the hybrid weights object modulates, giving less relevance to further observations (i.e., in this case those that only share a point):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_hy</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[0.7071067811865475,
 1.0,
 0.7071067811865475,
 1.0,
 1.0,
 0.7071067811865475,
 1.0,
 0.7071067811865475]
</pre></div>
</div>
</div>
</div>
</section>
<section id="great-circle-distances">
<h3>Great circle distances<a class="headerlink" href="#great-circle-distances" title="Permalink to this headline">#</a></h3>
<p>We must make one final curve before leaving the distance based weights. It is important that the
calculation of distances between objects takes the curvature of the Earth’s
surface into account. This can be done before computing the spatial weights object,
by transforming the coordinates of data points into a projected reference system. If
this is not possible or convenient, an approximation that considers the
curvature implicit in non-projected reference systems (e.g.,
longitude/latitude) can be a sufficient workaround. <code class="docutils literal notranslate"><span class="pre">pysal</span></code> provides such
approximation as part of its functionality.</p>
<p>To illustrate the relevance of ignoring this aspect altogether, we will examine
distance based weights for the case of counties in the state of Texas. First, let us compute
a KNN-4 object that ignores the curvature of the Earth’s surface (note how we use
in this case the <code class="docutils literal notranslate"><span class="pre">from_shapefile</span></code> constructor to build the weights directly from a
shapefile full of polygons):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ignore curvature of the earth</span>
<span class="n">knn4_bad</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_shapefile</span><span class="p">(</span>
    <span class="s2">&quot;../data/texas/texas.shp&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Next, let us take curvature into account. To do this, we require the
radius of the Earth expressed in a given metric. <code class="docutils literal notranslate"><span class="pre">pysal</span></code> provides this number
in both miles and kilometers. For the sake of the example, we will use miles:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">radius</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">sphere</span><span class="o">.</span><span class="n">RADIUS_EARTH_MILES</span>
<span class="n">radius</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3958.755865744055
</pre></div>
</div>
</div>
</div>
<p>With this measure at hand, we can pass it to the weights constructor (either
straight from a shapefile or from a <code class="docutils literal notranslate"><span class="pre">GeoDataFrame</span></code>), and distances will be
expressed in the units we have used for the radius, that is in miles in our
case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">knn4</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_shapefile</span><span class="p">(</span>
    <span class="s2">&quot;../data/texas/texas.shp&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="n">radius</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Comparing the resulting neighbor sets, we see that ignoring the curvature of the
Earth’s surface can create erroneous neighbor pairs. For example, the four <em>correct</em> nearest neighbors to observation 0 when accounting for the Earth’s curvature are 6, 4, 5, and 3. However, observation 13 is <em>ever so slightly</em> closer when computing the straight line distance instead of the distance that accounts for curvature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">knn4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{6: 1.0, 4: 1.0, 5: 1.0, 3: 1.0}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">knn4_bad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{6: 1.0, 4: 1.0, 5: 1.0, 13: 1.0}
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="block-weights">
<h2>Block weights<a class="headerlink" href="#block-weights" title="Permalink to this headline">#</a></h2>
<p>A final type of spatial weight we examine here is block weights. In this case,
it is membership in a geographic
group that defines the neighbor relationships. Block weights connect every
observation in a dataset that belongs to the same category in a provided list.<a class="footnote-reference brackets" href="#regions" id="id2">1</a>
In essence, a block weight structure groups
individual observations and considers all members of the group as “near” one another. This means that they then have a value of one for every pair of observations in the same group. Contrariwise, all members <em>not</em> in that group are considered disconnected from any observation within the group, and given a value of zero.
This is done for every group, so the resulting matrix looks like “blocks” of 1s stacked on the diagonal (assuming that observations in the same group are near one another in the input data table), hence the “block” weights.</p>
<p>To demonstrate this class of spatial weights, we will use the tract dataset for
San Diego and focus on their county membership:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">san_diego_tracts</span><span class="p">[[</span><span class="s2">&quot;GEOID&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;county&quot;</span><span class="p">,</span> <span class="s2">&quot;tract&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GEOID</th>
      <th>state</th>
      <th>county</th>
      <th>tract</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>06073018300</td>
      <td>06</td>
      <td>073</td>
      <td>018300</td>
    </tr>
    <tr>
      <th>1</th>
      <td>06073018601</td>
      <td>06</td>
      <td>073</td>
      <td>018601</td>
    </tr>
    <tr>
      <th>2</th>
      <td>06073017601</td>
      <td>06</td>
      <td>073</td>
      <td>017601</td>
    </tr>
    <tr>
      <th>3</th>
      <td>06073019301</td>
      <td>06</td>
      <td>073</td>
      <td>019301</td>
    </tr>
    <tr>
      <th>4</th>
      <td>06073018700</td>
      <td>06</td>
      <td>073</td>
      <td>018700</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Every tract has a unique ID (<code class="docutils literal notranslate"><span class="pre">GEOID</span></code>) and a county ID, shared by all tracts in
the same county. Since the entire region of San Diego is in California, the
state ID is the same across the dataset.</p>
<p>To build a block weights object, we do not even need spatial data beyond the
list of memberships. In this case, we will use the county membership:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NOTE: since this is a large dataset, it might take a while to process</span>
<span class="n">w_bl</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">block_weights</span><span class="p">(</span>
    <span class="n">san_diego_tracts</span><span class="p">[</span><span class="s2">&quot;county&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">ids</span><span class="o">=</span><span class="n">san_diego_tracts</span><span class="p">[</span><span class="s2">&quot;GEOID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As a check, let’s consider the first two rows in the table above. If the block
weights command has worked out correctly, both should be neighbors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;06073000201&quot;</span> <span class="ow">in</span> <span class="n">w_bl</span><span class="p">[</span><span class="s2">&quot;06073000100&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>We can use block weights as an intermediate step in more involved analyses
of “hybrid” spatial relationships. Suppose, for example, the researcher wanted to allow for
Queen neighbors within counties but not for tracts across different counties.
In this case, tracts from different counties would not be considered neighbors. To create such
as spatial weights matrix would require a combination of the Queen and the block
criteria, and <code class="docutils literal notranslate"><span class="pre">pysal</span></code> can implement that blending through one of the set operations shown in the next section.</p>
</section>
<section id="set-operations-on-weights">
<h2>Set operations on weights<a class="headerlink" href="#set-operations-on-weights" title="Permalink to this headline">#</a></h2>
<p>So far, we have seen different principles that guide how to build spatial
weights matrices. In this section, we explore how we can create new matrices
by <em>combining</em> different existing ones. This is useful in contexts where a
single neighborhood rule is inapt or when guiding principles
point to combinations of criteria.</p>
<p>We will explore these ideas in the section by returning to the San Diego tracts.
A number of ways exist to expand the basic criteria we have reviewed above and create
hybrid weights. In this example, we will generate a combination of the original contiguity
weights and the nearest neighbor weights. We will examine two different
approaches that provide similar solutions, thus illustrating the value of set
operations in <code class="docutils literal notranslate"><span class="pre">pysal</span></code>.</p>
<section id="editing-connecting-disconnected-observations">
<h3>Editing/connecting disconnected observations<a class="headerlink" href="#editing-connecting-disconnected-observations" title="Permalink to this headline">#</a></h3>
<p>Imagine one of our tracts was an island and did not have any neighbors in the contiguity case. This can
create issues in the spatial analytics that build on spatial weights, so it is good practice
to amend the matrix before using it.
The first approach we adopt is to find the nearest neighbor for the island observation
and then add this pair of neighbors to extend the neighbor pairs from the
original contiguity weight to obtain a fully connected set of weights.</p>
<p>We will assume, for the sake of the example, that the disconnected observation was number 103. For us to reattach this tract, we can assign it to be “connected” to its nearest neighbor. Let’s first extract our “problem” geometry:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">disconnected_tract</span> <span class="o">=</span> <span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">103</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</div>
<p>As we have seen above, this tract <em>does</em> have neighbors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_queen</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{160: 1.0, 480: 1.0, 98: 1.0, 324: 1.0, 102: 1.0, 107: 1.0, 173: 1.0}
</pre></div>
</div>
</div>
</div>
<p>But, for this example, we will assume it does not and thus we find ourselves in the position of having to create additional neighboring units. This approach does not only apply in the context of islands. Sometimes, the process we are interested in may require that we manually edit the weights to better reflect connections we want to capture.</p>
<p>We will connect the observation to its nearest neighbor. To do this, we can construct the KNN graph as we did above, but set <code class="docutils literal notranslate"><span class="pre">k=1</span></code>, so observations are only assigned to their nearest neighbor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wk1</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">san_diego_tracts</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In this graph, all our observations are connected to one other observation by construction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wk1</span><span class="o">.</span><span class="n">histogram</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[(1, 628)]
</pre></div>
</div>
</div>
</div>
<p>So is, of course, our tract of interest:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">wk1</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[102]
</pre></div>
</div>
</div>
</div>
<p>To connect it in our initial matrix, we need to create a copy of the <code class="docutils literal notranslate"><span class="pre">neighbors</span></code> dictionary and update the entry for <code class="docutils literal notranslate"><span class="pre">103</span></code>, including <code class="docutils literal notranslate"><span class="pre">102</span></code> as a neighbor. We copy the neighbors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neighbors</span> <span class="o">=</span> <span class="n">w_rook</span><span class="o">.</span><span class="n">neighbors</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>and then we change the entry for the island observation to include its
nearest neighbor (<code class="docutils literal notranslate"><span class="pre">102</span></code>) as well as update <code class="docutils literal notranslate"><span class="pre">102</span></code> to have <code class="docutils literal notranslate"><span class="pre">103</span></code> as a neighbor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neighbors</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">102</span><span class="p">)</span>
<span class="n">neighbors</span><span class="p">[</span><span class="mi">102</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">103</span><span class="p">)</span>
<span class="n">w_new</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">W</span><span class="p">(</span><span class="n">neighbors</span><span class="p">)</span>
<span class="n">w_new</span><span class="p">[</span><span class="mi">103</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{480: 1.0, 160: 1.0, 324: 1.0, 102: 1.0, 107: 1.0, 173: 1.0}
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-the-union-of-matrices">
<h3>Using the <code class="docutils literal notranslate"><span class="pre">union</span></code> of matrices<a class="headerlink" href="#using-the-union-of-matrices" title="Permalink to this headline">#</a></h3>
<p>A more elegant approach to the island problem makes use of <code class="docutils literal notranslate"><span class="pre">pysal</span></code>’s support for
<em>set theoretic operations</em> on <code class="docutils literal notranslate"><span class="pre">pysal</span></code> weights. For example, we can construct the <em>union</em> of two weighting schemes, connecting any pair of observations if they are connected in <em>either</em> the Rook or if they are nearest neighbors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w_fixed_sets</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">set_operations</span><span class="o">.</span><span class="n">w_union</span><span class="p">(</span><span class="n">w_rook</span><span class="p">,</span> <span class="n">wk1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>It is important to mention that this approach is not exactly the same, at least
in principle, as the one above. It could be that the nearest
observation was not originally a Rook neighbor and, in this case, the resulting
matrices would differ. This is a rare but theoretically possible situation.</p>
</section>
</section>
<section id="visualizing-weight-set-operations">
<h2>Visualizing weight set operations<a class="headerlink" href="#visualizing-weight-set-operations" title="Permalink to this headline">#</a></h2>
<p>To further build the intuition behind different criteria, in this section
we illustrate these concepts using the 32 states of Mexico.
We compare the neighbor graphs that results from some of the
criteria introduced to define neighbor relations. We first read in the data for Mexico:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/mexico/mexicojoin.shp&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will contrast the look of the connectivity graphs built following several criteria; so, to streamline things, let’s build the weights objects first:</p>
<ul class="simple">
<li><p>Queen contiguity</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx_queen</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">contiguity</span><span class="o">.</span><span class="n">Queen</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">mx</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(K\)</span>-NN with four nearest neighbors</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx_knn4</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>Block weights at the federal region level</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx_bw</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">block_weights</span><span class="p">(</span><span class="n">mx</span><span class="p">[</span><span class="s2">&quot;INEGI2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p>A combination of block and Queen that connects contiguous neighbors <em>across</em> regions</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx_union</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">set_operations</span><span class="o">.</span><span class="n">w_union</span><span class="p">(</span><span class="n">mx_bw</span><span class="p">,</span> <span class="n">mx_queen</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With these at hand, we will build a figure that shows the connectivity graph of each weights object. For cases where the federal regions are used to define blocks, we will color states based on the region they belong to.</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure and axis</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="c1"># Contiguity</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">mx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">mx_queen</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mx</span><span class="p">,</span>
    <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">),</span>
    <span class="n">node_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Queen&quot;</span><span class="p">)</span>

<span class="c1"># KNN</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">mx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">mx_knn4</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mx</span><span class="p">,</span>
    <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">),</span>
    <span class="n">node_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;$K$-NN 4&quot;</span><span class="p">)</span>

<span class="c1"># Block</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">mx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;INEGI2&quot;</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Pastel2&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">mx_bw</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mx</span><span class="p">,</span>
    <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">),</span>
    <span class="n">node_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Block weights&quot;</span><span class="p">)</span>

<span class="c1"># Union</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">mx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">column</span><span class="o">=</span><span class="s2">&quot;INEGI2&quot;</span><span class="p">,</span> <span class="n">categorical</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Pastel2&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">mx_union</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">mx</span><span class="p">,</span>
    <span class="n">edge_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">),</span>
    <span class="n">node_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">),</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Queen + Block&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/f6b6969633f127350f1e6314fea0c4a1a77caaa92574920bd2b2fd78508ca664.png" src="../_images/f6b6969633f127350f1e6314fea0c4a1a77caaa92574920bd2b2fd78508ca664.png" />
</div>
</div>
<p>Queen and KNN graphs are relatively similar but, as one would expect, the KNN is sparser than Queen in areas with high density of irregular polygons (Queen will connect each to more than four), and denser in sparser areas with less but larger polygons (e.g., northwest). Focusing on the Queen and Block graphs, there are clear distinctions between the
connectivity structures. The Block graph is visually denser in particular areas relative to the
Queen graph, and this is captured in their sparsity measures:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx_bw</span><span class="o">.</span><span class="n">pct_nonzero</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19.140625
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mx_queen</span><span class="o">.</span><span class="n">pct_nonzero</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>13.4765625
</pre></div>
</div>
</div>
</div>
<p>The other distinguishing characteristic can be seen in the number of connected
components in the different graphs. The Queen graph has a single connected
component, which in graph theory terms, means for all pairs of states there is
at least one path of edges that connects the two states. The Block graph has
five connected components, one for each of the five regions. Moreover, each of
these connected components is fully-connected, meaning there is an edge that
directly connects each pair of member states. However, there are no edges
between states belonging to different blocks (or components).</p>
<p>As we will see in later chapters, certain spatial analytical techniques require
a fully connected weights graph. In these cases, we could adopt the Queen
definition since this satisfies the single connected component requirement.
However, we may wish to use the Union weights graph, as that provides a single
connected component, but offers a blend of different types of connectivity
intensities, with the intra-regional (block) linkages being very dense, while
the inter-regional linkages are thinner but provide for the single connected
component.</p>
</section>
<section id="use-case-boundary-detection">
<h2>Use case: boundary detection<a class="headerlink" href="#use-case-boundary-detection" title="Permalink to this headline">#</a></h2>
<p>We close the chapter with an illustration of how weights can be useful by themselves in geographic data science. Note that the application displayed below involves some concepts and code that are a bit more advanced than in the rest of the chapter. If you are up for the challenge, we think the insights it enables are worth the effort!</p>
<p>Spatial weights are ubiquitous in the analysis of spatial patterns in data, since they provide a direct method to represent spatial structure.
However, spatial weights are also useful in their own right, such as when examining latent structures directly in the graphs themselves or when using them to conduct descriptive analysis.
One clear use case that arises in the analysis of social data is to characterize latent <em>data discontinuities</em>. By <em>data discontinuity</em>, we mean a single border (or collection of borders) where data for a variable (or many variables) of interest change abruptly.
These can be used in models of inequality <span id="id3">[<a class="reference internal" href="references.html#id22" title="Nema Dean, Guanpeng Dong, Aneta Piekut, and Gwilym Pryce. Frontiers in residential segregation: understanding neighbourhood boundaries and their impacts. Tijdschrift voor economische en sociale geografie, 110(3):271–288, 2019.">DDPP19</a>, <a class="reference internal" href="references.html#id24" title="Matthew C Fitzpatrick, Evan L Preisser, Adam Porter, Joseph Elkinton, Lance A Waller, Bradley P Carlin, and Aaron M Ellison. Ecological boundary detection using bayesian areal wombling. Ecology, 91(12):3448–3455, 2010.">FPP+10</a>, <a class="reference internal" href="references.html#id40" title="Haolan Lu and Bradley P Carlin. Bayesian areal wombling for geographical boundary analysis. Geographical Analysis, 37(3):265–285, 2005.">LC05</a>]</span> or used to adapt classic empirical outlier detection methods.
Below, we’ll show one model-free way to identify empirical boundaries in your data.</p>
<p>First, let’s consider the median household income for our census tracts in San Diego, shown in the following figure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="n">san_diego_tracts</span><span class="p">[</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0af31a2c4d2913af0fc479fee87444318648dde27e858f127c182a76bfddbcfa.png" src="../_images/0af31a2c4d2913af0fc479fee87444318648dde27e858f127c182a76bfddbcfa.png" />
</div>
</div>
<p>Now, we see some cases where there are very stark differences between neighboring areas, and some cases where there appear to be no difference between adjacent areas. Digging into this, we can examine the <em>distribution of differences</em> in neighboring areas using the adjacency list, a different representation of a spatial graph:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjlist</span> <span class="o">=</span> <span class="n">w_rook</span><span class="o">.</span><span class="n">to_adjlist</span><span class="p">()</span>
<span class="n">adjlist</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>focal</th>
      <th>neighbor</th>
      <th>weight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>4</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>27</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>383</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>385</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>This provides us with a table featuring three columns. <code class="docutils literal notranslate"><span class="pre">Focal</span></code> is the column containing the “origin” of the link, <code class="docutils literal notranslate"><span class="pre">neighbor</span></code> is the column containing the “destination” of the link, or neighbor of the focal polygon, and <code class="docutils literal notranslate"><span class="pre">weight</span></code> contains how strong the link from <code class="docutils literal notranslate"><span class="pre">focal</span></code> to <code class="docutils literal notranslate"><span class="pre">neighbor</span></code> is. Since our weights are <em>symmetrical</em>, this table contains two entries per pair of neighbors, one for <code class="docutils literal notranslate"><span class="pre">(focal,neighbor)</span></code> and the other for <code class="docutils literal notranslate"><span class="pre">(neighbor,focal)</span></code>.</p>
<p>Now we want to connect this table representing spatial structure with information on median household income. Using <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, we can merge up the focal units’ and neighboring units’ median household incomes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjlist_income</span> <span class="o">=</span> <span class="n">adjlist</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">san_diego_tracts</span><span class="p">[[</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">]],</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;focal&quot;</span><span class="p">,</span>
    <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">san_diego_tracts</span><span class="p">[[</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">]],</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;neighbor&quot;</span><span class="p">,</span>
    <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_focal&quot;</span><span class="p">,</span> <span class="s2">&quot;_neighbor&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="n">adjlist_income</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 3440 entries, 0 to 3439
Data columns (total 5 columns):
 #   Column                     Non-Null Count  Dtype  
---  ------                     --------------  -----  
 0   focal                      3440 non-null   int64  
 1   neighbor                   3440 non-null   int64  
 2   weight                     3440 non-null   float64
 3   median_hh_income_focal     3440 non-null   float64
 4   median_hh_income_neighbor  3440 non-null   float64
dtypes: float64(3), int64(2)
memory usage: 161.2 KB
</pre></div>
</div>
</div>
</div>
<p>This operation brings together the income at both the focal observation and the neighbor observation. The difference between these two yields income differences between <em>adjacent</em> tracts:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;median_hh_income_focal&quot;</span><span class="p">]</span>
    <span class="o">-</span> <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;median_hh_income_neighbor&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>With this information on difference we can now do a few things. First, we can compare whether or not this <em>distribution</em> is distinct from the distribution of non-neighboring tracts’ differences in wealth. This will give us a hint at the extent to which income follows a spatial pattern. This is also discussed more in depth in the spatial inequality chapter, specifically in reference to the Spatial Gini.</p>
<p>To do this, we can first compute the all-pairs differences in income using the <code class="docutils literal notranslate"><span class="pre">numpy.subtract</span></code> function. Some functions in <code class="docutils literal notranslate"><span class="pre">numpy</span></code> have special functionality; these <code class="docutils literal notranslate"><span class="pre">ufuncs</span></code> (short for “universal functions”) often support special applications to your data. Here, we will use <code class="docutils literal notranslate"><span class="pre">numpy.subtract.outer</span></code> to take the difference over the “outer Cartesian product” of two vectors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">all_pairs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">subtract</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span>
    <span class="n">san_diego_tracts</span><span class="p">[</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">san_diego_tracts</span><span class="p">[</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>In practice, this results in an <span class="math notranslate nohighlight">\(N\times N\)</span> array that stores the subtraction of all  combinations of the input vectors.</p>
<p>Then, we need to filter out those cells of <code class="docutils literal notranslate"><span class="pre">all_pairs</span></code> that are neighbors. Fortunately, our weights matrix is <em>binary</em>. So, subtracting it from an <span class="math notranslate nohighlight">\(N \times N\)</span> matrix of <span class="math notranslate nohighlight">\(1\)</span>s will result in the <em>complement</em> of our original weights matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complement_wr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_rook</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Note <code class="docutils literal notranslate"><span class="pre">complement_wr</span></code> inserts a 0 where <code class="docutils literal notranslate"><span class="pre">w_rook</span></code> includes a 1, and vice versa. Using this complement, we can filter the <code class="docutils literal notranslate"><span class="pre">all_pairs</span></code> matrix to only consider the differences in median household income for tracts that are not neighboring:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">non_neighboring_diffs</span> <span class="o">=</span> <span class="p">(</span><span class="n">complement_wr</span> <span class="o">*</span> <span class="n">all_pairs</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can compare the two distributions of the difference in wealth:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">non_neighboring_diffs</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgrey&quot;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Nonneighbors&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;salmon&quot;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Neighbors&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Dollar Differences ($)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c19790c1e1b53706eefd158864b16ea91763eb9999b4ecc18cbc4870ceed7df6.png" src="../_images/c19790c1e1b53706eefd158864b16ea91763eb9999b4ecc18cbc4870ceed7df6.png" />
</div>
</div>
<p>From this, we can see that the two distributions are distinct, with the distribution of difference in <em>non-neighboring</em> tracts being slightly more dispersed than that for <em>neighboring</em> tracts. Thus, on the whole, this means that neighboring tracts have more <em>smaller differences in wealth</em> than non-neighboring tracts. This is consistent with the behavior we will talk about in later chapters concerning <em>spatial autocorrelation</em>, the tendency for observations to be statistically more similar to nearby observations than they are to distant observations.</p>
<p>The adjacency table we have built can also help us find our <em>most extreme</em> observed differences in income, hinting at possible hard boundaries between the areas. Since our links are symmetric, we can then focus only on focal observations with <em>the most extreme</em> difference in wealth from their immediate neighbors, considering only those where the <em>focal</em> is higher, since they each have an equivalent <em>negative</em> back-link.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">extremes</span> <span class="o">=</span> <span class="n">adjlist_income</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
<span class="n">extremes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>focal</th>
      <th>neighbor</th>
      <th>weight</th>
      <th>median_hh_income_focal</th>
      <th>median_hh_income_neighbor</th>
      <th>diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2606</th>
      <td>473</td>
      <td>163</td>
      <td>1.0</td>
      <td>183929.0</td>
      <td>37863.0</td>
      <td>146066.0</td>
    </tr>
    <tr>
      <th>2605</th>
      <td>473</td>
      <td>157</td>
      <td>1.0</td>
      <td>183929.0</td>
      <td>64688.0</td>
      <td>119241.0</td>
    </tr>
    <tr>
      <th>1890</th>
      <td>343</td>
      <td>510</td>
      <td>1.0</td>
      <td>151797.0</td>
      <td>38125.0</td>
      <td>113672.0</td>
    </tr>
    <tr>
      <th>2607</th>
      <td>473</td>
      <td>238</td>
      <td>1.0</td>
      <td>183929.0</td>
      <td>74485.0</td>
      <td>109444.0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>8</td>
      <td>89</td>
      <td>1.0</td>
      <td>169821.0</td>
      <td>66563.0</td>
      <td>103258.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Thus, we see that observation <span class="math notranslate nohighlight">\(473\)</span> appears often on  the <code class="docutils literal notranslate"><span class="pre">focal</span></code> side, suggesting it’s quite distinct from its nearby polygons.</p>
<p>To verify whether these differences are truly significant, we can use a map randomization strategy. In this case, we shuffle values across the map and compute <em>new</em> <code class="docutils literal notranslate"><span class="pre">diff</span></code> columns. This time, <code class="docutils literal notranslate"><span class="pre">diff</span></code> represents the difference between random incomes, rather than the neighboring incomes we actually observed using our Rook contiguity matrix. Using many <code class="docutils literal notranslate"><span class="pre">diff</span></code> vectors, we can find the observed differences which tend to be much larger than those encountered in randomly-drawn maps of household income.</p>
<p>To start, we can construct many random <code class="docutils literal notranslate"><span class="pre">diff</span></code> vectors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## NOTE: this cell runs a simulation and may take a bit longer</span>
<span class="c1">## If you want it to run faster, decrease the number of shuffles</span>
<span class="c1">## by setting a lower value in `n_simulations`</span>

<span class="c1"># Set number or random shuffles</span>
<span class="n">n_simulations</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="c1"># Create an empty array to store results</span>
<span class="n">simulated_diffs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">adjlist</span><span class="p">),</span> <span class="n">n_simulations</span><span class="p">))</span>
<span class="c1"># Loop over each random draw</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
    <span class="c1"># Extract income values</span>
    <span class="n">median_hh_focal</span> <span class="o">=</span> <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;median_hh_income_focal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="c1"># Shuffle income values across locations</span>
    <span class="n">random_income</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">san_diego_tracts</span><span class="p">[[</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
    <span class="c1"># Join income to adjacency</span>
    <span class="n">adjlist_random_income</span> <span class="o">=</span> <span class="n">adjlist</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">random_income</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;focal&quot;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">random_income</span><span class="p">,</span>
        <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;neighbor&quot;</span><span class="p">,</span>
        <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_focal&quot;</span><span class="p">,</span> <span class="s2">&quot;_neighbor&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="c1"># Store reslults from random draw</span>
    <span class="n">simulated_diffs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">adjlist_random_income</span><span class="p">[</span><span class="s2">&quot;median_hh_income_focal&quot;</span><span class="p">]</span>
        <span class="o">-</span> <span class="n">adjlist_random_income</span><span class="p">[</span><span class="s2">&quot;median_hh_income_neighbor&quot;</span><span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>After running our simulation, we get many distributions of pairwise differences in household income. Below, we plot the shroud of all the simulated differences, shown in black, and our observed differences, shown in red:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up figure</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1"># Build background histogram for observed differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;salmon&quot;</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Plot simulated, random differences</span>
<span class="p">[</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">simulation</span><span class="p">,</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">simulation</span> <span class="ow">in</span> <span class="n">simulated_diffs</span><span class="o">.</span><span class="n">T</span>
<span class="p">]</span>
<span class="c1"># Build histogram borderline for observed differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">],</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Style figure</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Density&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Dollar Differences ($)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/e8cdfb2ea5b25c87f555fadee41ac1a9479db9340f2c77929882c8223a52e774.png" src="../_images/e8cdfb2ea5b25c87f555fadee41ac1a9479db9340f2c77929882c8223a52e774.png" />
</div>
</div>
<p>Again, our random distribution is much more dispersed than our observed distribution of the differences between nearby tracts. Empirically, we can pool our simulations and construct and use their quantiles to summarize how unlikely any of our <em>observed</em> differences are if neighbors’ household incomes were randomly assigned:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulated_diffs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(3440000,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Convert all simulated differences into a single vector</span>
<span class="n">pooled_diffs</span> <span class="o">=</span> <span class="n">simulated_diffs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="c1"># Calculate the 0.5th, 50th and 99.5th percentiles</span>
<span class="n">lower</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
    <span class="n">pooled_diffs</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># Create a swith that is True if the value is &quot;extreme&quot;</span>
<span class="c1"># (in the 0.5th percentile or/`|` in the 00.5th), False otherwise</span>
<span class="n">outside</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span>
    <span class="n">adjlist_income</span><span class="p">[</span><span class="s2">&quot;diff&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Despite the fact  that our observed differences are less dispersed on average, we can identify two boundaries in the data that are in the top 1% most extreme differences in neighboring household incomes across the map. These boundaries are shown in the table below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adjlist_income</span><span class="p">[</span><span class="n">outside</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>focal</th>
      <th>neighbor</th>
      <th>weight</th>
      <th>median_hh_income_focal</th>
      <th>median_hh_income_neighbor</th>
      <th>diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>888</th>
      <td>157</td>
      <td>473</td>
      <td>1.0</td>
      <td>64688.0</td>
      <td>183929.0</td>
      <td>-119241.0</td>
    </tr>
    <tr>
      <th>916</th>
      <td>163</td>
      <td>473</td>
      <td>1.0</td>
      <td>37863.0</td>
      <td>183929.0</td>
      <td>-146066.0</td>
    </tr>
    <tr>
      <th>2605</th>
      <td>473</td>
      <td>157</td>
      <td>1.0</td>
      <td>183929.0</td>
      <td>64688.0</td>
      <td>119241.0</td>
    </tr>
    <tr>
      <th>2606</th>
      <td>473</td>
      <td>163</td>
      <td>1.0</td>
      <td>183929.0</td>
      <td>37863.0</td>
      <td>146066.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Note that one of these, observation <span class="math notranslate nohighlight">\(473\)</span>, appears in both boundaries. This means that the observation is likely to be <em>outlying</em>, extremely unlike <em>all</em> of its neighbors. These kinds of generalized neighborhood comparisons are discussed in the subsequent chapter on local spatial autocorrelation. For now we can visualize this on a map, focusing on the two boundaries around observation <span class="math notranslate nohighlight">\(473\)</span>, shown also in the larger context of San Diego incomes:</p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot tracts</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s2">&quot;median_hh_income&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c1"># Zoom 1</span>
<span class="n">first_focus</span> <span class="o">=</span> <span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">473</span><span class="p">,</span> <span class="mi">157</span><span class="p">]]</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">first_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">first_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
<span class="p">)</span>
<span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">first_focus</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">total_bounds</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="c1"># Zoom 2</span>
<span class="n">second_focus</span> <span class="o">=</span> <span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">473</span><span class="p">,</span> <span class="mi">163</span><span class="p">]]</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">second_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">second_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>

<span class="c1"># Context</span>
<span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">san_diego_tracts</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">area_of_focus</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">first_focus</span><span class="p">,</span> <span class="n">second_focus</span><span class="p">))</span>
    <span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">12000</span><span class="p">)</span>
    <span class="o">.</span><span class="n">total_bounds</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">first_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">first_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">second_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">second_focus</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span>
<span class="p">)</span>
<span class="n">west</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">north</span> <span class="o">=</span> <span class="n">area_of_focus</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">west</span><span class="p">,</span> <span class="n">south</span><span class="p">,</span> <span class="n">east</span><span class="p">,</span> <span class="n">north</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="../_images/6b88e7a33bce088b51cd83db66da428c299bbb95356f51a9356373432c385e19.png" src="../_images/6b88e7a33bce088b51cd83db66da428c299bbb95356f51a9356373432c385e19.png" />
</div>
</div>
<p>These are the starkest contrasts in the map, and result in the most distinctive divisions between adjacent tracts’ household incomes.</p>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">#</a></h2>
<p>Spatial weights are central to how we <em>represent</em> spatial relationships in mathematical and computational environments. At their core, they are a “geo-graph,” or a network defined by the geographical relationships between observations. They form kind of a “spatial index,” in that they record which observations have a specific geographical relationship. Since spatial weights are fundamental to how spatial relationships are represented in geographic data science, we will use them again and again throughout the book.</p>
</section>
<section id="questions">
<h2>Questions<a class="headerlink" href="#questions" title="Permalink to this headline">#</a></h2>
<ol class="arabic">
<li><p>Rook contiguity and Queen contiguity are two of three kinds of contiguity that are defined in terms of chess analogies. The third kind, <em>Bishop contiguity</em>, applies when two observations are considered connected when they share single vertices, but are considered <em>disconnected</em> if they share an edge. This means that observations that exhibit Queen contiguity are those that exhibit either Rook or Bishop contiguity. Using the Rook and Queen contiguity matrices we built for San Diego and the <code class="docutils literal notranslate"><span class="pre">Wsets.w_difference</span></code> function, are there any Bishop-contiguous observations in San Diego?</p></li>
<li><p>Different kinds of spatial weights objects can result in very different kinds of graph structures. Considering the <code class="docutils literal notranslate"><span class="pre">cardinalities</span></code> of the Queen, Block, and the union of Queen and Block,</p>
<ol class="arabic simple">
<li><p>Which graph type has the highest average cardinality?</p></li>
<li><p>Which graph has more non-zero entries?</p></li>
<li><p>Why might this be the case?</p></li>
</ol>
</li>
<li><p>Graphs are considered “connected” when you can construct a path from any observation to every other observation. A “disconnected” graph has at least one node where there is no path from it to every other node. And, a “connected component” is a part of the graph that is connected internally, but it is disconnected from another part of the graph. This is reported for every spatial weights object in its <code class="docutils literal notranslate"><span class="pre">w.n_components</span></code>.</p>
<ol class="arabic simple">
<li><p>How many components does the Queen Contiguity weights for San Diego have?</p></li>
<li><p>Using a K-nearest Neighbor Graph for San Diego tracts where <span class="math notranslate nohighlight">\(k=1\)</span>, how many connected components are there in this graph?</p></li>
<li><p>Increase <span class="math notranslate nohighlight">\(k\)</span> by one until the <code class="docutils literal notranslate"><span class="pre">n_components</span></code> is 1. Make a plot of the relationship between <span class="math notranslate nohighlight">\(k\)</span> and <code class="docutils literal notranslate"><span class="pre">n_components</span></code>.</p></li>
<li><p>What value of <span class="math notranslate nohighlight">\(k\)</span> does <code class="docutils literal notranslate"><span class="pre">n_components</span></code> become 1?</p></li>
<li><p>How many non-zero links does this network have?</p></li>
</ol>
</li>
<li><p>Comparing their average cardinality and percentage of non-zero links, which graph in this chapter has the <em>most sparse</em> structure? That is, which graph is the most sparsely connected?</p></li>
<li><p>In this chapter, we worked with regular <em>square</em> lattices using the <code class="docutils literal notranslate"><span class="pre">lat2W</span></code> function. In the same manner, the <code class="docutils literal notranslate"><span class="pre">hexLat2W</span></code> function can generate <em>hexagonal regular lattices</em>. For lattices of size (3,3), (6,6), and (9,9) for Rook and Queen <code class="docutils literal notranslate"><span class="pre">lat2W</span></code>, as well as for <code class="docutils literal notranslate"><span class="pre">hexLat2W</span></code>:</p>
<ol class="arabic simple">
<li><p>Examine the average cardinality. Does <code class="docutils literal notranslate"><span class="pre">lat2W</span></code> or <code class="docutils literal notranslate"><span class="pre">hexLat2W</span></code> have higher average cardinality?</p></li>
<li><p>Further, make a histogram of the cardinalities. Which type of lattice has higher variation in its number of neighbors?</p></li>
<li><p>Why is there no <code class="docutils literal notranslate"><span class="pre">rook=True</span></code> option in <code class="docutils literal notranslate"><span class="pre">hexLat2W</span></code>, as there is in <code class="docutils literal notranslate"><span class="pre">lat2W</span></code>?</p></li>
</ol>
</li>
<li><p>The <em>Voronoi diagram</em> is a common method to construct polygons from a point dataset. A Voronoi diagram is built up from <em>Voronoi cells</em>, each of which contains the area that is closer to its source point than any other source point in the diagram. Further, the Queen contiguity graph for a <em>Voronoi diagram</em> obeys a number of useful properties, since it is the <em>Delaunay Triangulation</em> of a set of points.</p>
<ol class="arabic simple">
<li><p>Using the following code, build and plot the Voronoi diagram for the <em>centroids</em> of Mexican states, with the states and their centroids overlayed:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysal.lib.weights.distance</span> <span class="kn">import</span> <span class="n">get_points_array</span>
<span class="kn">from</span> <span class="nn">pysal.lib.cg</span> <span class="kn">import</span> <span class="n">voronoi_frames</span>

<span class="n">centroid_coordinates</span> <span class="o">=</span> <span class="n">get_points_array</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">centroid</span><span class="p">)</span>
<span class="n">cells</span><span class="p">,</span> <span class="n">centers</span> <span class="o">=</span> <span class="n">voronoi_frames</span><span class="p">(</span><span class="n">centroid_coordinates</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">mx</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;whitesmoke&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">mx</span><span class="o">.</span><span class="n">centroid</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="n">mx</span><span class="o">.</span><span class="n">total_bounds</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Using the <code class="docutils literal notranslate"><span class="pre">weights.Voronoi</span></code> function, build the Voronoi weights for the Mexico states data.</p></li>
<li><p>Compare the connections in the Voronoi and Queen weights for the Mexico states data. Which form is more connected?</p></li>
<li><p>Make a plot of the Queen contiguity and Voronoi contiguity graphs to compare them visually, like we did with the block weights and Queen weights. How do the two graphs compare in terms of the length of their links and how they connect the Mexican states?</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">weights.set_operations</span></code>, find any links that are in the Voronoi contiguity graph, but not in the Queen contiguity graph. Alternatively, find any links that are in the Queen contiguity graph, but not the Voronoi contiguity graph.</p></li>
</ol>
</li>
<li><p>Interoperability is important for the Python scientific stack. Thanks to standardization around the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array and the <code class="docutils literal notranslate"><span class="pre">scipy.sparse</span></code> array data structures, it is simple and computationally-easy to convert objects from one representation to another:</p>
<ol class="arabic simple">
<li><p>Using <code class="docutils literal notranslate"><span class="pre">w.to_networkx()</span></code>, convert the Mexico Regions Queen+Block weights matrix to a <code class="docutils literal notranslate"><span class="pre">networkx</span></code> graph. Compute the Eigenvector Centrality of that new object using <code class="docutils literal notranslate"><span class="pre">networkx.eigenvector_centrality</span></code></p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">w.sparse</span></code>, compute the number of connected components in the Mexico Regions Block weights matrix using the <code class="docutils literal notranslate"><span class="pre">connected_components</span></code> function in <code class="docutils literal notranslate"><span class="pre">scipy.sparse.csgraph</span></code>.</p></li>
<li><p>Using <code class="docutils literal notranslate"><span class="pre">w.sparse</span></code>, compute the all-pairs shortest path matrix in the Mexico Queen weights matrix using the <code class="docutils literal notranslate"><span class="pre">shortest_path</span></code> function in <code class="docutils literal notranslate"><span class="pre">scipy.sparse.csgraph</span></code>.</p></li>
</ol>
</li>
<li><p>While every node in a <span class="math notranslate nohighlight">\(k\)</span>-nearest neighbor graph has five neighbors, there is a conceptual difference between <em>in-degree</em> and <em>out-degree</em> of nodes in a graph. The <em>out-degree</em> of a node is the number of outgoing links from a node; for a K-Nearest Neighbor graph, this is <span class="math notranslate nohighlight">\(k\)</span> for every variable. The <em>in-degree</em> of a node in a graph is the number of <em>incoming</em> links to that node; for a K-Nearest Neighbor graph, this is the number of other observations that pick the target as their nearest neighbor. The <em>in-degree</em> of a node in the K-Nearest Neighbor graph can provide a measure of <em>hubbiness</em>, or how central a node is to other nodes.</p>
<ol class="arabic simple">
<li><p>Using the San Diego tracts data, build a <span class="math notranslate nohighlight">\(k=6\)</span> nearest neighbor weight and call it <code class="docutils literal notranslate"><span class="pre">knn_6</span></code>.</p></li>
<li><p>Verify that the <span class="math notranslate nohighlight">\(k=6\)</span> by taking the row sum over the weights matrix in <code class="docutils literal notranslate"><span class="pre">knn_6.sparse</span></code>.</p></li>
<li><p>Compute the in-degree of each observation by taking the <em>column sum</em> over the weights matrix in <code class="docutils literal notranslate"><span class="pre">knn_6.sparse</span></code>, and divide by 6, the out-degree for all observations.</p></li>
<li><p>Make a histogram of the in-degrees for the <span class="math notranslate nohighlight">\(k=6\)</span> weights. How evenly-distributed is the distribution of in-degrees?</p></li>
<li><p>Make a new histogram of the in-degree standardized by the out-degree when <span class="math notranslate nohighlight">\(k=26\)</span>. Does hubbiness reduce when increasing the number of <span class="math notranslate nohighlight">\(k\)</span>-nearest neighbors?</p></li>
</ol>
</li>
<li><p>Sometimes, graphs are not simple to construct. For the <code class="docutils literal notranslate"><span class="pre">san_diego_neighborhoods</span></code> dataset:</p>
<ol class="arabic simple">
<li><p>Build the Queen contiguity weights, and plot the graph on top of the neighborhoods themselves. How many connected components does this Queen contiguity graph have?</p></li>
<li><p>Build the K-Nearest Neighbor graph for the default, <span class="math notranslate nohighlight">\(k=2\)</span>. How many connected components does this K-Nearest Neighbor graph have?</p></li>
<li><p>What is the smallest <span class="math notranslate nohighlight">\(k\)</span> that you can find for the K-Nearest Neighbor graph to be fully-connected?</p></li>
<li><p>In graph theory, a link whose <em>removal</em> will increase the number of connected components in a graph is called a <em>bridge</em>. In the fully-connected KNN graph with the smallest <span class="math notranslate nohighlight">\(k\)</span>, how many bridges are there between the north and south components? <em>(hint: use the plotting functionality)</em></p></li>
<li><p>What are the next two values of <span class="math notranslate nohighlight">\(k\)</span> required for there to be an <em>additional</em> bridge at that <span class="math notranslate nohighlight">\(k\)</span>?</p></li>
</ol>
</li>
</ol>
</section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">#</a></h2>
<p>For additional reading and further information on the topic of networks and spatial weights matrices, consider chapter 3 of Anselin and Rey, <em>Modern Spatial Econometrics in Practice: A Guide to GeoDa, GeoDaSpace, and Pysal</em>. Further, for more general thinking on networks in geography, consider:</p>
<p>Uitermark, Justus and Michiel van Meeteren. 2021. “Geographcial Network Analysis.” <em>Tijdschrift voor economische en sociale geografie</em> 112: 337-350.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="regions"><span class="brackets"><a class="fn-backref" href="#id2">1</a></span></dt>
<dd><p>Usually, this list will have some relation to the spatial configuration of the data, but, technically speaking, all one needs to create block weights is a list of memberships.</p>
</dd>
</dl>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="03_spatial_data.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Spatial Data</p>
      </div>
    </a>
    <a class="right-next"
       href="../intro_part_ii.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Overview</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contiguity-weights">Contiguity weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-weights-from-real-world-geographic-tables">Spatial weights from real-world geographic tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-weights-from-surfaces">Spatial weights from surfaces</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-based-weights">Distance based weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k-nearest-neighbor-weights">K-nearest neighbor weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kernel-weights">Kernel weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#distance-bands-and-hybrid-weights">Distance bands and hybrid Weights</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#great-circle-distances">Great circle distances</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#block-weights">Block weights</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#set-operations-on-weights">Set operations on weights</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-connecting-disconnected-observations">Editing/connecting disconnected observations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-the-union-of-matrices">Using the <code class="docutils literal notranslate"><span class="pre">union</span></code> of matrices</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#visualizing-weight-set-operations">Visualizing weight set operations</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#use-case-boundary-detection">Use case: boundary detection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sergio J. Rey, Dani Arribas-Bel, Levi J. Wolf
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2020.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>