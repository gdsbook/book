

<!DOCTYPE html>


<html >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Spatial Regression &#8212; Geographic Data Science with Python</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-146598819-1"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-146598819-1');
            </script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'notebooks/11_regression';</script>
    <link rel="canonical" href="https://geographicdata.science/book/notebooks/11_regression.html" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Spatial Feature Engineering" href="12_feature_engineering.html" />
    <link rel="prev" title="Clustering and Regionalization" href="10_clustering_and_regionalization.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="None"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Home
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Preface</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="00_toc.html">Table of Contents</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part I - Building Blocks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_part_i.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="01_geo_thinking.html">Geographic Thinking for Data Scientists</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_geospatial_computational_environment.html">Computational Tools for Geographic Data Science</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_spatial_data.html">Spatial Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_spatial_weights.html">Spatial Weights</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part II - Spatial Data Analysis</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_part_ii.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_choropleth.html">Choropleth Mapping</a></li>
<li class="toctree-l1"><a class="reference internal" href="06_spatial_autocorrelation.html">Global Spatial Autocorrelation</a></li>
<li class="toctree-l1"><a class="reference internal" href="07_local_autocorrelation.html">Local Spatial Autocorrelation</a></li>
<li class="toctree-l1"><a class="reference internal" href="08_point_pattern_analysis.html">Point Pattern Analysis</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Part III - Advanced Topics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../intro_part_iii.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="09_spatial_inequality.html">Spatial Inequality Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="10_clustering_and_regionalization.html">Clustering and Regionalization</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spatial Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="12_feature_engineering.html">Spatial Feature Engineering</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Endmatter</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="references.html">References</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Datasets</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../data/README.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/airbnb/regression_cleaning.html">AirBnb</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/airports/airports_cleaning.html">Airports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/brexit/brexit_cleaning.html">Brexit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/countries/countries_cleaning.html">Countries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/ghsl/build_ghsl_extract.html">GHSL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/h3_grid/build_sd_h3_grid.html">H3 Grid</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/mexico/README.html">Mexico</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/nasadem/build_nasadem_sd.html">NASA DEM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/sandiego/sandiego_tracts_cleaning.html">San Diego Tracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/texas/README.html">Texas</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/tokyo/tokyo_cleaning.html">Tokyo Photographs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../data/us_county_income/README.html">US County Income 1969-2017</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/gdsbook/book/master?urlpath=lab/tree/notebooks/11_regression.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/gdsbook/book/blob/master/notebooks/11_regression.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/notebooks/11_regression.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spatial Regression</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-spatial-regression-and-why-should-i-care"><em>What</em> is spatial regression and <em>why</em> should I care?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-san-diego-airbnb">Data: San Diego Airbnb</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-spatial-regression-a-very-quick-refresh">Non-spatial regression, a (very) quick refresh</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hidden-structures">Hidden structures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bringing-space-into-the-regression-framework">Bringing space into the regression framework</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-feature-engineering-proximity-variables">Spatial feature engineering: proximity variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-heterogeneity">Spatial heterogeneity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-fixed-effects">Spatial fixed effects</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-regimes">Spatial regimes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-dependence">Spatial dependence</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exogenous-effects-the-slx-model">Exogenous effects: The SLX model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-error">Spatial error</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-lag">Spatial lag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#other-ways-of-bringing-space-into-regression">Other ways of bringing space into regression</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#challenge-questions">Challenge questions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-random-coast">The random coast</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-k-neighbor-correlogram">The K-neighbor correlogram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next steps</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spatial-regression">
<h1>Spatial Regression<a class="headerlink" href="#spatial-regression" title="Permalink to this headline">#</a></h1>
<p>Regression (and prediction more generally) provides us a perfect case to examine how spatial structure can help us understand and analyze our data. In this chapter, we discuss how spatial structure can be used to both validate and improve prediction algorithms, focusing on linear regression specifically.</p>
<section id="what-is-spatial-regression-and-why-should-i-care">
<h2><em>What</em> is spatial regression and <em>why</em> should I care?<a class="headerlink" href="#what-is-spatial-regression-and-why-should-i-care" title="Permalink to this headline">#</a></h2>
<p>Usually, spatial structure helps regression models in one of two ways.
The first (and most clear) way space can have an impact on our data is when the process <em>generating</em> the data is itself explicitly spatial.
Here, think of something like the prices for single family homes.
It’s often the case that individuals pay a premium on their house price in order to live in a better school district for the same quality house.
Alternatively, homes closer to noise or chemical polluters like waste water treatment plants, recycling facilities, or wide highways, may actually be cheaper than we would otherwise anticipate.
In cases like asthma incidence, the locations individuals tend to travel to throughout the day, such as their places of work or recreation, may have more impact on their health than their residential addresses.
In this case, it may be necessary to use data <em>from other sites</em> to predict the asthma incidence at a given site.
Regardless of the specific case at play, here, <em>geography is a feature</em>: it directly helps us make predictions about outcomes <em>because those outcomes are obtained from geographical processes</em>.</p>
<p>An alternative (and more skeptical understanding) reluctantly acknowledges geography’s instrumental value.
Often, in the analysis of predictive methods and classifiers, we are interested in analyzing what we get wrong.
This is common in econometrics; an analyst may be concerned that the model <em>systematically</em> mis-predicts some types of observations.
If we know our model routinely performs poorly on a known set of observations or type of input, we might make a better model if we can account for this.
Among other kinds of error diagnostics, geography provides us with an exceptionally useful embedding to assess structure in our errors.
Mapping classification/prediction error can help show whether or not there are <em>clusters of error</em> in our data.
If we <em>know</em> that errors tend to be larger in some areas than in other areas (or if error is “contagious” between observations), then we might be able to exploit this structure to make better predictions.</p>
<p>Spatial structure in our errors might arise from when geography <em>should be</em> an attribute somehow, but we are not sure exactly how to include it in our model.
They might also arise because there is some <em>other</em> feature whose omission causes the spatial patterns in the error we see; if this additional feature were included, the structure would disappear.
Or, it might arise from the complex interactions and interdependencies between the features that we have chosen to use as predictors, resulting in intrinsic structure in mis-prediction.
Most of the predictors we use in models of social processes contain <em>embodied</em> spatial information: patterning intrinsic to the feature that we get for free in the model.
If we intend to or not, using a spatially patterned predictor in a model can result in spatially patterned errors; using more than one can amplify this effect.
Thus, <em>regardless of whether or not the true process is explicitly geographic</em>, additional information about the spatial relationships between our observations or more information about nearby sites can make our predictions better.</p>
<p>In this chapter, we build space into the traditional regression framework. We begin with a standard linear regression model, devoid of any geographical reference. From there, we formalize space and spatial relationships in three main ways: first, encoding it in exogenous variables; second, through spatial heterogeneity, or as systematic variation of outcomes across space; third, as dependence, or through the effect associated to the characteristics of spatial neighbors. Throughout, we focus on the conceptual differences each approach entails rather than on the technical details.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysal.lib</span> <span class="kn">import</span> <span class="n">weights</span>
<span class="kn">from</span> <span class="nn">pysal.explore</span> <span class="kn">import</span> <span class="n">esda</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>
<span class="kn">import</span> <span class="nn">geopandas</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">contextily</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-san-diego-airbnb">
<h2>Data: San Diego Airbnb<a class="headerlink" href="#data-san-diego-airbnb" title="Permalink to this headline">#</a></h2>
<p>To learn a little more about how regression works, we’ll examine information about Airbnb properties in San Diego, CA.
This dataset contains house intrinsic characteristics, both continuous (number of beds as in <code class="docutils literal notranslate"><span class="pre">beds</span></code>) and categorical (type of renting or, in Airbnb jargon, property group as in the series of <code class="docutils literal notranslate"><span class="pre">pg_X</span></code> binary variables), but also variables that explicitly refer to the location and spatial configuration of the dataset (e.g., distance to Balboa Park, <code class="docutils literal notranslate"><span class="pre">d2balboa</span></code> or neighborhood id, <code class="docutils literal notranslate"><span class="pre">neighborhood_cleansed</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="s2">&quot;../data/airbnb/regression_db.geojson&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>These are the explanatory variables we will use throughout the chapter.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variable_names</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;accommodates&quot;</span><span class="p">,</span>  <span class="c1"># Number of people it accommodates</span>
    <span class="s2">&quot;bathrooms&quot;</span><span class="p">,</span>  <span class="c1"># Number of bathrooms</span>
    <span class="s2">&quot;bedrooms&quot;</span><span class="p">,</span>  <span class="c1"># Number of bedrooms</span>
    <span class="s2">&quot;beds&quot;</span><span class="p">,</span>  <span class="c1"># Number of beds</span>
    <span class="c1"># Below are binary variables, 1 True, 0 False</span>
    <span class="s2">&quot;rt_Private_room&quot;</span><span class="p">,</span>  <span class="c1"># Room type: private room</span>
    <span class="s2">&quot;rt_Shared_room&quot;</span><span class="p">,</span>  <span class="c1"># Room type: shared room</span>
    <span class="s2">&quot;pg_Condominium&quot;</span><span class="p">,</span>  <span class="c1"># Property group: condo</span>
    <span class="s2">&quot;pg_House&quot;</span><span class="p">,</span>  <span class="c1"># Property group: house</span>
    <span class="s2">&quot;pg_Other&quot;</span><span class="p">,</span>  <span class="c1"># Property group: other</span>
    <span class="s2">&quot;pg_Townhouse&quot;</span><span class="p">,</span>  <span class="c1"># Property group: townhouse</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="non-spatial-regression-a-very-quick-refresh">
<h2>Non-spatial regression, a (very) quick refresh<a class="headerlink" href="#non-spatial-regression-a-very-quick-refresh" title="Permalink to this headline">#</a></h2>
<p>Before we discuss how to explicitly include space into the linear regression framework, let us show how basic regression can be carried out in Python, and how one can begin to interpret the results. By no means is this a formal and complete introduction to regression so, if that is what you are looking for, we recommend <span id="id1">[<a class="reference internal" href="references.html#id27" title="Andrew Gelman and Jennifer Hill. Data Analysis Using Regression and Multilevel Hierarchical Models. Cambridge University Press, 2006. ISBN 9780511790942. URL: http://dx.doi.org/10.1017/cbo9780511790942, doi:10.1017/cbo9780511790942.">GH06</a>]</span>, in particular chapters 3 and 4, which provide a fantastic, non-spatial introduction.</p>
<p>The core idea of linear regression is to explain the variation in a given (<em>dependent</em>) variable as a linear function of a collection of other (<em>explanatory</em>) variables. For example, in our case, we may want to express the price of a house as a function of the number of bedrooms it has and whether it is a condominium or not. At the individual level, we can express this as:</p>
<div class="math notranslate nohighlight">
\[
P_i = \alpha + \sum_k \mathbf{X}_{ik}\beta_k  + \epsilon_i
\]</div>
<p>where <span class="math notranslate nohighlight">\(P_i\)</span> is the Airbnb price of house <span class="math notranslate nohighlight">\(i\)</span>, and <span class="math notranslate nohighlight">\(X\)</span> is a set of covariates that we use to explain such price (e.g., No. of bedrooms and condominium binary variable). <span class="math notranslate nohighlight">\(\beta\)</span> is a vector of parameters that give us information about in which way and to what extent each variable is related to the price, and <span class="math notranslate nohighlight">\(\alpha\)</span>, the constant term, is the average house price when all the other variables are zero. The term <span class="math notranslate nohighlight">\(\epsilon_i\)</span> is usually referred to as “error” and captures elements that influence the price of a house but are not included in <span class="math notranslate nohighlight">\(X\)</span>. We can also express this relation in matrix form, excluding sub-indices for <span class="math notranslate nohighlight">\(i\)</span>, which yields:</p>
<div class="math notranslate nohighlight">
\[
P = \alpha + \mathbf{X}\beta + \epsilon
\]</div>
<p>A regression can be seen as a multivariate extension of bivariate correlations. Indeed, one way to interpret the <span class="math notranslate nohighlight">\(\beta_k\)</span> coefficients in the equation above is as the degree of correlation between the explanatory variable <span class="math notranslate nohighlight">\(k\)</span> and the dependent variable, <em>keeping all the other explanatory variables constant</em>. When one calculates bivariate correlations, the coefficient of a variable is picking up the correlation between the variables, but it is also subsuming into it variation associated with other correlated variables – also called confounding factors. Regression allows us to isolate the distinct effect that a single variable has on the dependent one, once we <em>control</em> for those other variables.</p>
<p>Practically speaking, linear regressions in Python are rather streamlined and easy to work with. There are also several packages which will run them (e.g., <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>, <code class="docutils literal notranslate"><span class="pre">scikit-learn</span></code>, <code class="docutils literal notranslate"><span class="pre">pysal</span></code>). We will import the <code class="docutils literal notranslate"><span class="pre">spreg</span></code> module in Pysal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pysal.model</span> <span class="kn">import</span> <span class="n">spreg</span>
</pre></div>
</div>
</div>
</div>
<p>In the context of this chapter, it makes sense to start with <code class="docutils literal notranslate"><span class="pre">spreg</span></code>, as that is the only library that will allow us to move into explicitly spatial econometric models. To fit the model specified in the equation above with <span class="math notranslate nohighlight">\(X\)</span> as the list defined, using ordinary least squares (OLS), we only need the following line of code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit OLS model</span>
<span class="n">m1</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span>
    <span class="c1"># Dependent variable</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Independent variables</span>
    <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Dependent variable name</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;log_price&quot;</span><span class="p">,</span>
    <span class="c1"># Independent variable name</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">variable_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We use the command <code class="docutils literal notranslate"><span class="pre">OLS</span></code>, part of the <code class="docutils literal notranslate"><span class="pre">spreg</span></code> sub-package, and specify the dependent variable (the log of the price, so we can interpret results in terms of percentage change) and the explanatory ones. Note that both objects need to be arrays, so we extract them from the <code class="docutils literal notranslate"><span class="pre">pandas.DataFrame</span></code> object using <code class="docutils literal notranslate"><span class="pre">.values</span></code>.</p>
<p>In order to inspect the results of the model, we can print the <code class="docutils literal notranslate"><span class="pre">summary</span></code> attribute:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>REGRESSION
----------
SUMMARY OF OUTPUT: ORDINARY LEAST SQUARES
-----------------------------------------
Data set            :     unknown
Weights matrix      :        None
Dependent Variable  :   log_price                Number of Observations:        6110
Mean dependent var  :      4.9958                Number of Variables   :          11
S.D. dependent var  :      0.8072                Degrees of Freedom    :        6099
R-squared           :      0.6683
Adjusted R-squared  :      0.6678
Sum squared residual:    1320.148                F-statistic           :   1229.0564
Sigma-square        :       0.216                Prob(F-statistic)     :           0
S.E. of regression  :       0.465                Log likelihood        :   -3988.895
Sigma-square ML     :       0.216                Akaike info criterion :    7999.790
S.E of regression ML:      0.4648                Schwarz criterion     :    8073.685

------------------------------------------------------------------------------------
            Variable     Coefficient       Std.Error     t-Statistic     Probability
------------------------------------------------------------------------------------
            CONSTANT       4.3883830       0.0161147     272.3217773       0.0000000
        accommodates       0.0834523       0.0050781      16.4336318       0.0000000
           bathrooms       0.1923790       0.0109668      17.5419773       0.0000000
            bedrooms       0.1525221       0.0111323      13.7009195       0.0000000
                beds      -0.0417231       0.0069383      -6.0134430       0.0000000
     rt_Private_room      -0.5506868       0.0159046     -34.6244758       0.0000000
      rt_Shared_room      -1.2383055       0.0384329     -32.2198992       0.0000000
      pg_Condominium       0.1436347       0.0221499       6.4846529       0.0000000
            pg_House      -0.0104894       0.0145315      -0.7218393       0.4704209
            pg_Other       0.1411546       0.0228016       6.1905633       0.0000000
        pg_Townhouse      -0.0416702       0.0342758      -1.2157316       0.2241342
------------------------------------------------------------------------------------

REGRESSION DIAGNOSTICS
MULTICOLLINEARITY CONDITION NUMBER           11.964

TEST ON NORMALITY OF ERRORS
TEST                             DF        VALUE           PROB
Jarque-Bera                       2        2671.611           0.0000

DIAGNOSTICS FOR HETEROSKEDASTICITY
RANDOM COEFFICIENTS
TEST                             DF        VALUE           PROB
Breusch-Pagan test               10         322.532           0.0000
Koenker-Bassett test             10         135.581           0.0000
================================ END OF REPORT =====================================
</pre></div>
</div>
</div>
</div>
<p>A full detailed explanation of the output is beyond the scope of this chapter, so we will focus on the relevant bits for our main purpose. This is concentrated on the <code class="docutils literal notranslate"><span class="pre">Coefficients</span></code> section, which gives us the estimates for <span class="math notranslate nohighlight">\(\beta_k\)</span> in our model. In other words, these numbers express the relationship between each explanatory variable and the dependent one, once the effect of confounding factors has been accounted for. Keep in mind however that regression is no magic; we are only discounting the effect of confounding factors that we include in the model, not of <em>all</em> potentially confounding factors.</p>
<p>Results are largely as expected: houses tend to be significantly more expensive if they accommodate more people (<code class="docutils literal notranslate"><span class="pre">accommodates</span></code>), if they have more bathrooms and bedrooms, and if they are a condominium or part of the “other” category of house type. Conversely, given a number of rooms, houses with more beds (i.e., listings that are more “crowded”) tend to go for cheaper, as it is the case for properties where one does not rent the entire house but only a room (<code class="docutils literal notranslate"><span class="pre">rt_Private_room</span></code>) or even shares it (<code class="docutils literal notranslate"><span class="pre">rt_Shared_room</span></code>). Of course, you might conceptually doubt the assumption that it is possible to <em>arbitrarily</em> change the number of beds within an Airbnb without eventually changing the number of people it accommodates, but methods to address these concerns using <em>interaction effects</em> won’t be discussed here.</p>
<section id="hidden-structures">
<h3>Hidden structures<a class="headerlink" href="#hidden-structures" title="Permalink to this headline">#</a></h3>
<p>In general, our model performs well, being able to predict slightly about two-thirds (<span class="math notranslate nohighlight">\(R^2=0.67\)</span>) of the variation in the mean nightly price using the covariates we’ve discussed above.
But, our model might display some clustering in the errors, which may be a problem as that violates the i.i.d. assumption linear models usually come built-in with.
To interrogate this, we can do a few things.
One simple concept might be to look at the correlation between the error in predicting an Airbnb and the error in predicting its nearest neighbor.
To examine this, we first might want to split our data up by regions and see if we’ve got some spatial structure in our residuals.
One reasonable theory might be that our model does not include any information about <em>beaches</em>, a critical aspect of why people live and vacation in San Diego.
Therefore, we might want to see whether or not our errors are higher or lower depending on whether or not an Airbnb is in a “beach” neighborhood, a neighborhood near the ocean. We use the code below to generate Figure XXX1XXX, which looks at prices between the two groups of houses, “beach” and “no beach”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a Boolean (True/False) with whether a</span>
<span class="c1"># property is coastal or not</span>
<span class="n">is_coastal</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">coastal</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
<span class="c1"># Split residuals (m1.u) between coastal and not</span>
<span class="n">coastal</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">is_coastal</span><span class="p">]</span>
<span class="n">not_coastal</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="o">~</span><span class="n">is_coastal</span><span class="p">]</span>
<span class="c1"># Create histogram of the distribution of coastal residuals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">coastal</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coastal&quot;</span><span class="p">)</span>
<span class="c1"># Create histogram of the distribution of non-coastal residuals</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">not_coastal</span><span class="p">,</span>
    <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Not Coastal&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Add Line on 0</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="c1"># Add legend</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="c1"># Display</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ec693a0037b28c1ce83adcde45969779ee885c961b9162d7ba92da4bc1c8a4a3.png" src="../_images/ec693a0037b28c1ce83adcde45969779ee885c961b9162d7ba92da4bc1c8a4a3.png" />
</div>
</div>
<p>While it appears that the neighborhoods on the coast have only slightly higher average errors (and have lower variance in their prediction errors), the two distributions are significantly distinct from one another when compared using a classic <span class="math notranslate nohighlight">\(t\)</span>-test:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ttest_ind</span>

<span class="n">ttest_ind</span><span class="p">(</span><span class="n">coastal</span><span class="p">,</span> <span class="n">not_coastal</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Ttest_indResult(statistic=array([13.98193858]), pvalue=array([9.442438e-44]))
</pre></div>
</div>
</div>
</div>
<p>There are more sophisticated (and harder to fool) tests that may be applicable for this data, however. We cover them in the <span class="xref myst">Challenge</span> section.</p>
<p>Additionally, it might be the case that some neighborhoods are more desirable than other neighborhoods due to unmodeled latent preferences or marketing.
For instance, despite its presence close to the sea, living near Camp Pendleton -a Marine base in the North of the city- may incur some significant penalties on area desirability due to noise and pollution. These are questions that domain knowledge provides and data analysis can help us answer.
For us to determine whether this is the case, we might be interested in the full distribution of model residuals within each neighborhood.</p>
<p>To make this more clear, we’ll first sort the data by the median residual in that neighborhood, and then make a boxplot (Fig. XXX2XXX), which shows the distribution of residuals in each neighborhood:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create column with residual values from m1</span>
<span class="n">db</span><span class="p">[</span><span class="s2">&quot;residual&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span>
<span class="c1"># Obtain the median value of residuals in each neighborhood</span>
<span class="n">medians</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;neighborhood&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">residual</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;hood_residual&quot;</span><span class="p">)</span>
<span class="p">)</span>

<span class="c1"># Increase fontsize</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>
<span class="c1"># Set up figure</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1"># Grab figure&#39;s axis</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="c1"># Generate bloxplot of values by neighborhood</span>
<span class="c1"># Note the data includes the median values merged on-the-fly</span>
<span class="n">seaborn</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;neighborhood&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;residual&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">data</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
        <span class="n">medians</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;neighborhood&quot;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;hood_residual&quot;</span><span class="p">),</span>
    <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Rotate the X labels for legibility</span>
<span class="n">f</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">(</span><span class="n">rotation</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>
<span class="c1"># Display</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/13c9fa3b2bb1479886d8db26285badfeba8b59de4cabc3226cca582ba622a13a.png" src="../_images/13c9fa3b2bb1479886d8db26285badfeba8b59de4cabc3226cca582ba622a13a.png" />
</div>
</div>
<p>No neighborhood is disjoint from one another, but some do appear to be higher than others, such as the well-known downtown tourist neighborhoods areas of the Gaslamp Quarter, Little Italy, or The Core.
Thus, there may be a distinctive effect of intangible neighborhood fashionableness that matters in this model.</p>
<p>Noting that many of the most over- and under-predicted neighborhoods are near one another in the city, it may also be the case that there is some sort of <em>contagion</em> or spatial spillovers in the nightly rent price.
This often is apparent when individuals seek to price their Airbnb listings to compete with similar nearby listings.
Since our model is not aware of this behavior, its errors may tend to cluster.
One exceptionally simple way we can look into this structure is by examining the relationship between an observation’s residuals and its surrounding residuals.</p>
<p>To do this, we will use <em>spatial weights</em> to represent the geographic relationships between observations.
We cover spatial weights in detail in <a class="reference internal" href="04_spatial_weights.html"><span class="doc std std-doc">Chapter 4</span></a>, so we will not repeat ourselves here.
For this example, we’ll start off with a <span class="math notranslate nohighlight">\(KNN\)</span> matrix where <span class="math notranslate nohighlight">\(k=1\)</span>, meaning we’re focusing only on the linkages of each Airbnb to their closest other listing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">knn</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">KNN</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This means that, when we compute the <em>spatial lag</em> of that <span class="math notranslate nohighlight">\(KNN\)</span> weight and the residual, we get the residual of the Airbnb listing closest to each observation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag_residual</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">spatial_lag</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">lag_residual</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">line_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">),</span>
    <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Model Residuals - $u$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Spatial Lag of Model Residuals - $W u$&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1fc7c4f07a5cd63073d44349db28a9e4eb432f9c8d4af3f30e7870229bb6b737.png" src="../_images/1fc7c4f07a5cd63073d44349db28a9e4eb432f9c8d4af3f30e7870229bb6b737.png" />
</div>
</div>
<p>In Figure XXX3XXX, we see that our prediction errors tend to cluster!
Above, we show the relationship between our prediction error at each site and the prediction error at the site nearest to it.
Here, we’re using this nearest site to stand in for the <em>surroundings</em> of that Airbnb.
This means that, when the model tends to over-predict a given Airbnb’s nightly log price, sites around that Airbnb are more likely to <em>also be over-predicted</em>. An interesting property of this relationship is that it tends to stabilize as the number of nearest neighbors used to construct each Airbnb’s surroundings increases.
Consult the <span class="xref myst">Challenge</span> section for more on this property.</p>
<p>Given this behavior, let’s look at the stable <span class="math notranslate nohighlight">\(k=20\)</span> number of neighbors.
Examining the relationship between this stable <em>surrounding</em> average and the focal Airbnb, we can even find clusters in our model error.
Recalling the <em>local Moran</em> statistics in <a class="reference internal" href="07_local_autocorrelation.html"><span class="doc std std-doc">Chapter 7</span></a>, Figure XXX4XXX is generated from the code below to identify certain areas where our predictions of the nightly (log) Airbnb price tend to be significantly off:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Re-weight W to 20 nearest neighbors</span>
<span class="n">knn</span><span class="o">.</span><span class="n">reweight</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># Row standardize weights</span>
<span class="n">knn</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="s2">&quot;R&quot;</span>
<span class="c1"># Run LISA on residuals</span>
<span class="n">outliers</span> <span class="o">=</span> <span class="n">esda</span><span class="o">.</span><span class="n">moran</span><span class="o">.</span><span class="n">Moran_Local</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">,</span> <span class="n">knn</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="mi">9999</span><span class="p">)</span>
<span class="c1"># Select only LISA cluster cores</span>
<span class="n">error_clusters</span> <span class="o">=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">q</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span>
<span class="c1"># Filter out non-significant clusters</span>
<span class="n">error_clusters</span> <span class="o">&amp;=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">p_sim</span> <span class="o">&lt;=</span> <span class="mf">0.001</span>
<span class="c1"># Add `error_clusters` and `local_I` columns</span>
<span class="n">ax</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">error_clusters</span><span class="o">=</span><span class="n">error_clusters</span><span class="p">,</span>
        <span class="n">local_I</span><span class="o">=</span><span class="n">outliers</span><span class="o">.</span><span class="n">Is</span>
        <span class="c1"># Retain error clusters only</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="s2">&quot;error_clusters&quot;</span>
        <span class="c1"># Sort by I value to largest plot on top</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
        <span class="s2">&quot;local_I&quot;</span>
        <span class="c1"># Plot I values</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s2">&quot;local_I&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;bwr&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># Add basemap</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="c1"># Remove axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f2ab629b462d0639fc58c879f0796ece8276c05e822949e1b5c5bf23fe7248ae.png" src="../_images/f2ab629b462d0639fc58c879f0796ece8276c05e822949e1b5c5bf23fe7248ae.png" />
</div>
</div>
<p>Thus, these areas tend to be locations where our model significantly under-predicts the nightly Airbnb price both for that specific observation and observations in its immediate surroundings.
This is critical since, if we can identify how these areas are structured — if they have a <em>consistent geography</em> that we can model — then we might make our predictions even better, or at least not systematically mis-predict prices in some areas while correctly predicting prices in other areas. Since significant under- and over-predictions do appear to cluster in a highly structured way, we might be able to use a better model to fix the geography of our model errors.</p>
</section>
</section>
<section id="bringing-space-into-the-regression-framework">
<h2>Bringing space into the regression framework<a class="headerlink" href="#bringing-space-into-the-regression-framework" title="Permalink to this headline">#</a></h2>
<p>There are many different ways that spatial structure shows up in our models, predictions, and our data, even if we do not explicitly intend to study it.
Fortunately, there are nearly as many techniques, called <em>spatial regression</em> methods, that are designed to handle these sorts of structures.
Spatial regression is about <em>explicitly</em> introducing space or geographical context into the statistical framework of a regression.
Conceptually, we want to introduce space into our model whenever we think it plays an important role in the process we are interested in, or when space can act as a reasonable proxy for other factors that we cannot but should include in our model.
As an example of the former, we can imagine how houses at the seafront are probably more expensive than those in the second row, given their better views.
To illustrate the latter, we can think of how the character of a neighborhood is important in determining the price of a house; however, it is very hard to identify and quantify “character” per se, although it might be easier to get at its spatial variation, hence a case of space as a proxy.</p>
<p>Spatial regression is a large field of development in the econometrics and statistics literatures.
In this brief introduction, we will consider two related but very different processes that give rise to spatial effects: spatial heterogeneity and spatial dependence. Before diving into them, we begin with another approach that introduces space in a regression model without modifying the model itself but rather creates spatially explicit independent variables.
For more rigorous treatments of the topics introduced here, we refer you to <span id="id2">[<a class="reference internal" href="references.html#id10" title="Luc Anselin. Spatial externalities, spatial multipliers, and spatial econometrics. International Regional Science Review, 26(2):153–166, Apr 2003. URL: http://dx.doi.org/10.1177/0160017602250972, doi:10.1177/0160017602250972.">Ans03</a>, <a class="reference internal" href="references.html#id11" title="Luc Anselin and Sergio J. Rey. Modern spatial econometrics in practice: A guide to GeoDa, GeoDaSpace, and PySAL. GeoDa Press, 2014.">AR14</a>, <a class="reference internal" href="references.html#id27" title="Andrew Gelman and Jennifer Hill. Data Analysis Using Regression and Multilevel Hierarchical Models. Cambridge University Press, 2006. ISBN 9780511790942. URL: http://dx.doi.org/10.1017/cbo9780511790942, doi:10.1017/cbo9780511790942.">GH06</a>]</span>.</p>
<section id="spatial-feature-engineering-proximity-variables">
<h3>Spatial feature engineering: proximity variables<a class="headerlink" href="#spatial-feature-engineering-proximity-variables" title="Permalink to this headline">#</a></h3>
<p>Using geographic information to “construct” new data is a common approach to bring in spatial information into data analysis.
Often, this reflects the fact that processes are not the same everywhere in the map of analysis, or that geographical information may be useful to predict our outcome of interest. In this section, we will briefly present how to insert <em>spatial features</em>, or <span class="math notranslate nohighlight">\(X\)</span> variables that are constructed from geographical relationships, in a standard linear model. We discuss spatial feature engineering extensively in <a class="reference internal" href="12_feature_engineering.html"><span class="doc std std-doc">Chapter 12</span></a>, though, and the depth and extent of spatial feature engineering is difficult to over-state. Rather than detail, this section will show how spatially explicit variables you engineer can be “plugged” into a model to improve its performance or help you explain the underlying process of interest with more accuracy.</p>
<p>One relevant proximity-driven variable that could influence our San Diego model is based on the listings proximity to Balboa Park. A common tourist destination, Balboa Park is a central recreation hub for the city of San Diego, containing many museums and the San Diego Zoo. Thus, it could be the case that people searching for Airbnbs in San Diego are willing to pay a premium to live closer to the park. If this were true <em>and</em> we omitted this from our model, we may indeed see a significant spatial pattern caused by this distance decay effect.</p>
<p>Therefore, this is sometimes called a <em>spatially patterned omitted covariate</em>: geographic information our model needs to make good predictions which we have left out of our model. Therefore, let’s build a new model containing this distance to Balboa Park covariate. First, though, it helps to visualize (Fig. XXX5XXX) the structure of this distance covariate itself:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s2">&quot;d2balboa&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4ccef307211bf7a69130fff678f2c6c0e94415b4c7250acdf7d921d80c4f8bd0.png" src="../_images/4ccef307211bf7a69130fff678f2c6c0e94415b4c7250acdf7d921d80c4f8bd0.png" />
</div>
</div>
<p>To run a linear model that includes the additional variable of distance to the park, we add the name to the list of variables we included originally:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">balboa_names</span> <span class="o">=</span> <span class="n">variable_names</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;d2balboa&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>And then fit the model using the OLS class in Pysal’s <code class="docutils literal notranslate"><span class="pre">spreg</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m2</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">db</span><span class="p">[</span><span class="n">balboa_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;log_price&quot;</span><span class="p">,</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">balboa_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>When you inspect the regression diagnostics and output, you see that this covariate is not quite as helpful as we might anticipate:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[[</span><span class="n">m1</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">ar2</span><span class="p">],</span> <span class="p">[</span><span class="n">m2</span><span class="o">.</span><span class="n">r2</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">ar2</span><span class="p">]],</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;M1&quot;</span><span class="p">,</span> <span class="s2">&quot;M2&quot;</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;R2&quot;</span><span class="p">,</span> <span class="s2">&quot;Adj. R2&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>R2</th>
      <th>Adj. R2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>M1</th>
      <td>0.668345</td>
      <td>0.667801</td>
    </tr>
    <tr>
      <th>M2</th>
      <td>0.668502</td>
      <td>0.667904</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>It is not statistically significant at conventional significance levels, the model fit does not substantially change:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up table of regression coefficients</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="c1"># Pull out regression coefficients and</span>
        <span class="c1"># flatten as they are returned as Nx1 array</span>
        <span class="s2">&quot;Coeff.&quot;</span><span class="p">:</span> <span class="n">m2</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out and flatten standard errors</span>
        <span class="s2">&quot;Std. Error&quot;</span><span class="p">:</span> <span class="n">m2</span><span class="o">.</span><span class="n">std_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out P-values from t-stat object</span>
        <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m2</span><span class="o">.</span><span class="n">t_stat</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="n">m2</span><span class="o">.</span><span class="n">name_x</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coeff.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CONSTANT</th>
      <td>4.379624</td>
      <td>0.016915</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>accommodates</th>
      <td>0.083644</td>
      <td>0.005079</td>
      <td>1.156896e-59</td>
    </tr>
    <tr>
      <th>bathrooms</th>
      <td>0.190791</td>
      <td>0.011005</td>
      <td>9.120139e-66</td>
    </tr>
    <tr>
      <th>bedrooms</th>
      <td>0.150746</td>
      <td>0.011179</td>
      <td>7.418035e-41</td>
    </tr>
    <tr>
      <th>beds</th>
      <td>-0.041476</td>
      <td>0.006939</td>
      <td>2.394322e-09</td>
    </tr>
    <tr>
      <th>rt_Private_room</th>
      <td>-0.552996</td>
      <td>0.015960</td>
      <td>2.680270e-240</td>
    </tr>
    <tr>
      <th>rt_Shared_room</th>
      <td>-1.235521</td>
      <td>0.038462</td>
      <td>2.586867e-209</td>
    </tr>
    <tr>
      <th>pg_Condominium</th>
      <td>0.140459</td>
      <td>0.022225</td>
      <td>2.803765e-10</td>
    </tr>
    <tr>
      <th>pg_House</th>
      <td>-0.013302</td>
      <td>0.014623</td>
      <td>3.630396e-01</td>
    </tr>
    <tr>
      <th>pg_Other</th>
      <td>0.141176</td>
      <td>0.022798</td>
      <td>6.309880e-10</td>
    </tr>
    <tr>
      <th>pg_Townhouse</th>
      <td>-0.045784</td>
      <td>0.034356</td>
      <td>1.826992e-01</td>
    </tr>
    <tr>
      <th>d2balboa</th>
      <td>0.001645</td>
      <td>0.000967</td>
      <td>8.902052e-02</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>And, there still appears to be spatial structure in our model’s errors, as we can see in Figure XXX6XXX, generated by the code below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lag_residual</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">spatial_lag</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">m2</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">seaborn</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span>
    <span class="n">x</span><span class="o">=</span><span class="n">m2</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">y</span><span class="o">=</span><span class="n">lag_residual</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
    <span class="n">line_kws</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">),</span>
    <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Residuals ($u$)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Spatial lag of residuals ($Wu$)&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9162f324f2410ffda1a4daa427fe014db134c00e74b62443c1c2c23e310b6ab4.png" src="../_images/9162f324f2410ffda1a4daa427fe014db134c00e74b62443c1c2c23e310b6ab4.png" />
</div>
</div>
<p>Finally, the distance to Balboa Park variable does not fit our theory about how distance to amenity should affect the price of an Airbnb; the coefficient estimate is <em>positive</em>, meaning that people are paying a premium to be <em>further</em> from Balboa Park. We will revisit this result later on, when we consider spatial heterogeneity and will be able to shed some light on this. Further, the next chapter is an extensive treatment of spatial fixed effects, presenting many more spatial feature engineering methods. Here, we have only showed how to include these engineered features in a standard linear modeling framework.</p>
</section>
<section id="spatial-heterogeneity">
<h3>Spatial heterogeneity<a class="headerlink" href="#spatial-heterogeneity" title="Permalink to this headline">#</a></h3>
<p>So far we have assumed that our proximity variable might stand in for a difficult-to-measure premium individuals pay when they’re close to a recreational zone (a park in this case). Our approach in that case was to incorporate space through a very specific channel, that is the distance to an amenity we thought might be influencing the final price. However, not all neighborhoods have the same house prices; some neighborhoods may be systematically more expensive than others, regardless of their proximity to Balboa Park. If this is our case, we need some way to account for the fact that each neighborhood may experience these kinds of <em>gestalt</em>, unique effects. One way to do this is by capturing <em>spatial heterogeneity</em> (SH). At its most basic, <em>spatial heterogeneity</em> means that parts of the model may vary systematically with geography, change in different places. For example, changes to the intercept, <span class="math notranslate nohighlight">\(\alpha\)</span>, may reflect the fact that different areas have different baseline exposures to a given process. Changes to the slope terms, <span class="math notranslate nohighlight">\(\beta\)</span>, may indicate some kind of geographical mediating factor that makes the relationship between the independent and dependent variables vary across space, such as when a governmental policy is not consistently applied across jurisdictions. Finally, changes to the variance of the residuals, commonly denoted <span class="math notranslate nohighlight">\(\sigma^2\)</span>, can introduce spatial heteroskedasticity. We deal with the first two in this section.</p>
<section id="spatial-fixed-effects">
<h4>Spatial fixed effects<a class="headerlink" href="#spatial-fixed-effects" title="Permalink to this headline">#</a></h4>
<p>The literature commonly refers to geographic variations of <span class="math notranslate nohighlight">\(\alpha\)</span> as “spatial fixed effects (FE)”. To illustrate them, let us consider the house price example from the previous section. Sometimes, spatial fixed effects are said to capture “space as a proxy”, in that we know the outcome varies over space, we (hope to) know the pattern it follows (in our case, by neighborhood) and we can thus incorporate that knowledge into the model by letting <span class="math notranslate nohighlight">\(\alpha\)</span> vary accordingly. The rationale goes as follows. Given we are only including a few explanatory variables in the model, it is likely we are missing some important factors that play a role at determining the price at which a house is sold. Some of them, however, are likely to vary systematically over space (e.g., different neighborhood characteristics). If that is the case, we can control for those unobserved factors by using traditional binary variables but basing their creation on a spatial rule. For example, let us include a binary variable for every neighborhood, indicating whether a given house is located within such area (<code class="docutils literal notranslate"><span class="pre">1</span></code>) or not (<code class="docutils literal notranslate"><span class="pre">0</span></code>). Mathematically, we are now fitting the following equation:</p>
<div class="math notranslate nohighlight">
\[
\log{P_i} = \alpha_r + \sum_k \mathbf{X}_{ik}\beta_k  + \epsilon_i
\]</div>
<p>where the main difference is that we are now allowing the constant term, <span class="math notranslate nohighlight">\(\alpha\)</span>, to vary by neighborhood <span class="math notranslate nohighlight">\(r\)</span>, <span class="math notranslate nohighlight">\(\alpha_r\)</span>.</p>
<p>Programmatically, we will show two different ways we can estimate this: one,
using <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>; and two, with <code class="docutils literal notranslate"><span class="pre">spreg</span></code>. First, we will use <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>, the econometrician’s toolbox in Python.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">sm</span>
</pre></div>
</div>
</div>
</div>
<p>This package provides a formula-like API, which allows us to express the <em>equation</em> we wish to estimate directly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;log_price ~ &quot;</span>
    <span class="o">+</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">variable_names</span><span class="p">)</span>
    <span class="o">+</span> <span class="s2">&quot; + neighborhood - 1&quot;</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>log_price ~ accommodates + bathrooms + bedrooms + beds + rt_Private_room + rt_Shared_room + pg_Condominium + pg_House + pg_Other + pg_Townhouse + neighborhood - 1
</pre></div>
</div>
</div>
</div>
<p>The <em>tilde</em> operator in this statement is usually read as “log price is a function of …”, to account for the fact that many different model specifications can be fit according to that functional relationship between <code class="docutils literal notranslate"><span class="pre">log_price</span></code> and our covariate list. Critically, note that the trailing <code class="docutils literal notranslate"><span class="pre">-1</span></code> term means that we are fitting this model without an intercept term. This is necessary, since including an intercept term alongside unique means for every neighborhood would make the underlying system of equations underspecified.</p>
<p>Using this expression, we can estimate the unique effects of each neighborhood, fitting the model in <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code> (note how the specification of the model, formula and data is separated from the fitting step):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m3</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We could rely on the <code class="docutils literal notranslate"><span class="pre">summary2()</span></code> method to print a similar summary report from the regression but, given it is a lengthy one in this case, we will illustrate how you can extract the spatial fixed effects into a table for display.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Store variable names for all the spatial fixed effects</span>
<span class="n">sfe_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m3</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s2">&quot;neighborhood[&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
<span class="c1"># Create table</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;Coef.&quot;</span><span class="p">:</span> <span class="n">m3</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">sfe_names</span><span class="p">],</span>
        <span class="s2">&quot;Std. Error&quot;</span><span class="p">:</span> <span class="n">m3</span><span class="o">.</span><span class="n">bse</span><span class="p">[</span><span class="n">sfe_names</span><span class="p">],</span>
        <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="n">m3</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="n">sfe_names</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coef.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>neighborhood[Balboa Park]</th>
      <td>4.280766</td>
      <td>0.033292</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Bay Ho]</th>
      <td>4.198251</td>
      <td>0.076878</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Bay Park]</th>
      <td>4.329223</td>
      <td>0.050987</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Carmel Valley]</th>
      <td>4.389261</td>
      <td>0.056553</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[City Heights West]</th>
      <td>4.053518</td>
      <td>0.058378</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Clairemont Mesa]</th>
      <td>4.095259</td>
      <td>0.047699</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[College Area]</th>
      <td>4.033697</td>
      <td>0.058258</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Core]</th>
      <td>4.726186</td>
      <td>0.052643</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Cortez Hill]</th>
      <td>4.608090</td>
      <td>0.051526</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Del Mar Heights]</th>
      <td>4.496910</td>
      <td>0.054337</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[East Village]</th>
      <td>4.545469</td>
      <td>0.029373</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Gaslamp Quarter]</th>
      <td>4.775799</td>
      <td>0.047304</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Grant Hill]</th>
      <td>4.306742</td>
      <td>0.052365</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Grantville]</th>
      <td>4.053298</td>
      <td>0.071396</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Kensington]</th>
      <td>4.302671</td>
      <td>0.077176</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[La Jolla]</th>
      <td>4.682084</td>
      <td>0.025809</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[La Jolla Village]</th>
      <td>4.330311</td>
      <td>0.077237</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Linda Vista]</th>
      <td>4.191149</td>
      <td>0.056916</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Little Italy]</th>
      <td>4.666742</td>
      <td>0.046838</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Loma Portal]</th>
      <td>4.301909</td>
      <td>0.033236</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Marina]</th>
      <td>4.558298</td>
      <td>0.047994</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Midtown]</th>
      <td>4.366661</td>
      <td>0.028394</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Midtown District]</th>
      <td>4.584938</td>
      <td>0.065087</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Mira Mesa]</th>
      <td>3.989562</td>
      <td>0.056101</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Mission Bay]</th>
      <td>4.515479</td>
      <td>0.022422</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Mission Valley]</th>
      <td>4.275960</td>
      <td>0.074231</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Moreno Mission]</th>
      <td>4.400942</td>
      <td>0.056730</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Normal Heights]</th>
      <td>4.097400</td>
      <td>0.049022</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[North Clairemont]</th>
      <td>3.984440</td>
      <td>0.069149</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[North Hills]</th>
      <td>4.253425</td>
      <td>0.025478</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Northwest]</th>
      <td>4.173752</td>
      <td>0.069728</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Ocean Beach]</th>
      <td>4.437164</td>
      <td>0.030088</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Old Town]</th>
      <td>4.420160</td>
      <td>0.041893</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Otay Ranch]</th>
      <td>4.185941</td>
      <td>0.081597</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Pacific Beach]</th>
      <td>4.438829</td>
      <td>0.022417</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Park West]</th>
      <td>4.440907</td>
      <td>0.044768</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Rancho Bernadino]</th>
      <td>4.180906</td>
      <td>0.072010</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Rancho Penasquitos]</th>
      <td>4.162428</td>
      <td>0.061776</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Roseville]</th>
      <td>4.386992</td>
      <td>0.058623</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[San Carlos]</th>
      <td>4.334991</td>
      <td>0.083040</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Scripps Ranch]</th>
      <td>4.082380</td>
      <td>0.076244</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[Serra Mesa]</th>
      <td>4.312967</td>
      <td>0.059925</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[South Park]</th>
      <td>4.225311</td>
      <td>0.053643</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[University City]</th>
      <td>4.193718</td>
      <td>0.036965</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>neighborhood[West University Heights]</th>
      <td>4.297672</td>
      <td>0.043134</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The approach above shows how spatial FE are a particular case of a linear regression with a categorical  variable. Neighborhood membership is modeled using binary dummy variables. Thanks to the formula grammar used in <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>, we can express the model abstractly, and Python parses it, appropriately creating binary variables as required.</p>
<p>The second approach leverages <code class="docutils literal notranslate"><span class="pre">spreg</span></code> Regimes functionality. We will see regimes below but, for now, think of them as a generalization of spatial fixed effects where not only <span class="math notranslate nohighlight">\(\alpha\)</span> can vary. This framework allows the user to specify which variables are to be estimated separately for each group. In this case, instead of describing the model in a formula, we need to pass each element of the model as separate arguments.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># spreg spatial fixed effect implementation</span>
<span class="n">m4</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">OLS_Regimes</span><span class="p">(</span>
    <span class="c1"># Dependent variable</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Independent variables</span>
    <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Variable specifying neighborhood membership</span>
    <span class="n">db</span><span class="p">[</span><span class="s2">&quot;neighborhood&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="c1"># Allow the constant term to vary by group/regime</span>
    <span class="n">constant_regi</span><span class="o">=</span><span class="s2">&quot;many&quot;</span><span class="p">,</span>
    <span class="c1"># Variables to be allowed to vary (True) or kept</span>
    <span class="c1"># constant (False). Here we set all to False</span>
    <span class="n">cols2regi</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">variable_names</span><span class="p">),</span>
    <span class="c1"># Allow separate sigma coefficients to be estimated</span>
    <span class="c1"># by regime (False so a single sigma)</span>
    <span class="n">regime_err_sep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Dependent variable name</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;log_price&quot;</span><span class="p">,</span>
    <span class="c1"># Independent variables names</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">variable_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly as above, we could rely on the <code class="docutils literal notranslate"><span class="pre">summary</span></code> attribute to print a report with all the results computed. For simplicity here, we will only confirm that, to the 12th decimal, the parameters estimated are indeed the same as those we get from <code class="docutils literal notranslate"><span class="pre">statsmodels</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">numpy</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">m4</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">-</span> <span class="n">m3</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([ 0.e+00, -0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,
        0.e+00,  0.e+00, -1.e-12,  0.e+00,  0.e+00,  0.e+00,  0.e+00,
        0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,
        0.e+00,  0.e+00,  0.e+00, -0.e+00,  0.e+00,  0.e+00,  0.e+00,
        0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,
        0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00,
        0.e+00,  0.e+00,  0.e+00,  0.e+00, -0.e+00, -0.e+00,  0.e+00,
       -0.e+00, -0.e+00,  0.e+00,  0.e+00,  0.e+00,  0.e+00])
</pre></div>
</div>
</div>
</div>
<p>Econometrically speaking, what the neighborhood FEs we have introduced imply is that, instead of comparing all house prices across San Diego as equal, we only derive variation from within each postcode. Remember that the interpretation of <span class="math notranslate nohighlight">\(\beta_k\)</span> is the effect of variable <span class="math notranslate nohighlight">\(k\)</span>, <em>given all the other explanatory variables included remain constant</em>. By including a single variable for each area, we are effectively forcing the model to compare as equal only house prices that share the same value for each variable; or, in other words, only houses located within the same area. Introducing FE affords a higher degree of isolation of the effects of the variables we introduce in the model because we can control for unobserved effects that align spatially with the distribution of the FE introduced (by neighborhood, in our case). To make a map of neighborhood fixed effects, we need to process the results from our model slightly.</p>
<p>First, we extract only the effects pertaining to the neighborhoods:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">neighborhood_effects</span> <span class="o">=</span> <span class="n">m3</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;neighborhood&quot;</span><span class="p">)</span>
<span class="n">neighborhood_effects</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>neighborhood[Balboa Park]          4.280766
neighborhood[Bay Ho]               4.198251
neighborhood[Bay Park]             4.329223
neighborhood[Carmel Valley]        4.389261
neighborhood[City Heights West]    4.053518
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Then, we need to extract just the neighborhood name from the index of this Series. A simple way to do this is to strip all the characters that come before and after our neighborhood names:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a sequence with the variable names without</span>
<span class="c1"># `neighborhood[` and `]`</span>
<span class="n">stripped</span> <span class="o">=</span> <span class="n">neighborhood_effects</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span>
    <span class="s2">&quot;neighborhood[&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">)</span>
<span class="c1"># Reindex the neighborhood_effects Series on clean names</span>
<span class="n">neighborhood_effects</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">stripped</span>
<span class="c1"># Convert Series to DataFrame</span>
<span class="n">neighborhood_effects</span> <span class="o">=</span> <span class="n">neighborhood_effects</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">)</span>
<span class="c1"># Print top of table</span>
<span class="n">neighborhood_effects</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>fixed_effect</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Balboa Park</th>
      <td>4.280766</td>
    </tr>
    <tr>
      <th>Bay Ho</th>
      <td>4.198251</td>
    </tr>
    <tr>
      <th>Bay Park</th>
      <td>4.329223</td>
    </tr>
    <tr>
      <th>Carmel Valley</th>
      <td>4.389261</td>
    </tr>
    <tr>
      <th>City Heights West</th>
      <td>4.053518</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Good, we’re back to our raw neighborhood names. These allow us to join it to an auxillary file with neighborhood boundaries that is indexed on the same names. Let’s read the boundaries first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sd_path</span> <span class="o">=</span> <span class="s2">&quot;../data/airbnb/neighbourhoods.geojson&quot;</span>
<span class="n">neighborhoods</span> <span class="o">=</span> <span class="n">geopandas</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">sd_path</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And we can then merge the spatial FE and plot them on a map (Fig. XXX7XXX):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot base layer with all neighborhoods in grey</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">neighborhoods</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
<span class="p">)</span>
<span class="c1"># Merge SFE estimates (note not every polygon</span>
<span class="c1"># receives an estimate since not every polygon</span>
<span class="c1"># contains Airbnb properties)</span>
<span class="n">neighborhoods</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
    <span class="n">neighborhood_effects</span><span class="p">,</span>
    <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
    <span class="n">left_on</span><span class="o">=</span><span class="s2">&quot;neighbourhood&quot;</span><span class="p">,</span>
    <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span>
    <span class="c1"># Drop polygons without a SFE estimate</span>
<span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
    <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;fixed_effect&quot;</span><span class="p">]</span>
    <span class="c1"># Plot quantile choropleth</span>
<span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="s2">&quot;fixed_effect&quot;</span><span class="p">,</span>  <span class="c1"># Variable to display</span>
    <span class="n">scheme</span><span class="o">=</span><span class="s2">&quot;quantiles&quot;</span><span class="p">,</span>  <span class="c1"># Choropleth scheme</span>
    <span class="n">k</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>  <span class="c1"># No. of classes in the choropleth</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Polygon border width</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span>  <span class="c1"># Color scheme</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>  <span class="c1"># Axis to draw on</span>
<span class="p">)</span>
<span class="c1"># Add basemap</span>
<span class="n">contextily</span><span class="o">.</span><span class="n">add_basemap</span><span class="p">(</span>
    <span class="n">ax</span><span class="p">,</span>
    <span class="n">crs</span><span class="o">=</span><span class="n">neighborhoods</span><span class="o">.</span><span class="n">crs</span><span class="p">,</span>
    <span class="n">source</span><span class="o">=</span><span class="n">contextily</span><span class="o">.</span><span class="n">providers</span><span class="o">.</span><span class="n">CartoDB</span><span class="o">.</span><span class="n">PositronNoLabels</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Remove axis</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span>
<span class="c1"># Display</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/141721ac6d5a4ec9f63f547e62daa4524ccafc4fcadacffd91eb00fee6522bff.png" src="../_images/141721ac6d5a4ec9f63f547e62daa4524ccafc4fcadacffd91eb00fee6522bff.png" />
</div>
</div>
<p>We can see a clear spatial structure in the SFE estimates. The most expensive neighborhoods tend to be located near the coast, while the cheapest ones are more inland.</p>
</section>
<section id="spatial-regimes">
<h4>Spatial regimes<a class="headerlink" href="#spatial-regimes" title="Permalink to this headline">#</a></h4>
<p>At the core of estimating spatial FEs is the idea that, instead of assuming the dependent variable behaves uniformly over space, there are systematic effects following a geographical pattern that affect its behavior. In other words, spatial FEs introduce econometrically the notion of spatial heterogeneity. They do this in the simplest possible form: by allowing the constant term to vary geographically. The other elements of the regression are left untouched and hence apply uniformly across space. The idea of spatial regimes (SRs) is to generalize the spatial FE approach to allow not only the constant term to vary but also any other explanatory variable. This implies that the equation we will be estimating is:</p>
<div class="math notranslate nohighlight">
\[
\log{P_i} = \alpha_r + \sum_k \mathbf{X}_{ki}\beta_{k-r} + \epsilon_i
\]</div>
<p>where we are not only allowing the constant term to vary by region (<span class="math notranslate nohighlight">\(\alpha_r\)</span>), but also every other parameter (<span class="math notranslate nohighlight">\(\beta_{k-r}\)</span>).</p>
<p>To illustrate this approach, we will use the “spatial differentiator” of whether a house is in a coastal neighborhood or not (<code class="docutils literal notranslate"><span class="pre">coastal_neig</span></code>) to define the regimes. The rationale behind this choice is that renting a house close to the ocean might be a strong enough pull that people might be willing to pay at different <em>rates</em> for each of the house’s characteristics.</p>
<p>To implement this in Python, we use the <code class="docutils literal notranslate"><span class="pre">OLS_Regimes</span></code> class in <code class="docutils literal notranslate"><span class="pre">spreg</span></code>, which does most of the heavy lifting for us:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pysal spatial regimes implementation</span>
<span class="n">m5</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">OLS_Regimes</span><span class="p">(</span>
    <span class="c1"># Dependent variable</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Independent variables</span>
    <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Variable specifying neighborhood membership</span>
    <span class="n">db</span><span class="p">[</span><span class="s2">&quot;coastal&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
    <span class="c1"># Allow the constant term to vary by group/regime</span>
    <span class="n">constant_regi</span><span class="o">=</span><span class="s2">&quot;many&quot;</span><span class="p">,</span>
    <span class="c1"># Allow separate sigma coefficients to be estimated</span>
    <span class="c1"># by regime (False so a single sigma)</span>
    <span class="n">regime_err_sep</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="c1"># Dependent variable name</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;log_price&quot;</span><span class="p">,</span>
    <span class="c1"># Independent variables names</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">variable_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The result can be explored and interpreted similarly to the previous ones. If you inspect the <code class="docutils literal notranslate"><span class="pre">summary</span></code> attribute, you will find the parameters for each variable mostly conform to what you would expect, across both regimes. To compare them, we can plot them side-by-side on a bespoke table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Results table</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="c1"># Pull out regression coefficients and</span>
        <span class="c1"># flatten as they are returned as Nx1 array</span>
        <span class="s2">&quot;Coeff.&quot;</span><span class="p">:</span> <span class="n">m5</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out and flatten standard errors</span>
        <span class="s2">&quot;Std. Error&quot;</span><span class="p">:</span> <span class="n">m5</span><span class="o">.</span><span class="n">std_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out P-values from t-stat object</span>
        <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m5</span><span class="o">.</span><span class="n">t_stat</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="n">m5</span><span class="o">.</span><span class="n">name_x</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Coastal regime</span>
<span class="c1">## Extract variables for the coastal regime</span>
<span class="n">coastal</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s2">&quot;1_&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
<span class="c1">## Subset results to coastal and remove the 1_ underscore</span>
<span class="n">coastal</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">coastal</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;1_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<span class="c1">## Build multi-index column names</span>
<span class="n">coastal</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
    <span class="p">[[</span><span class="s2">&quot;Coastal&quot;</span><span class="p">],</span> <span class="n">coastal</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Non-coastal model</span>
<span class="c1">## Extract variables for the non-coastal regime</span>
<span class="n">ncoastal</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="s2">&quot;0_&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
<span class="c1">## Subset results to non-coastal and remove the 0_ underscore</span>
<span class="n">ncoastal</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ncoastal</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;0_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
<span class="c1">## Build multi-index column names</span>
<span class="n">ncoastal</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">pandas</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span>
    <span class="p">[[</span><span class="s2">&quot;Non-coastal&quot;</span><span class="p">],</span> <span class="n">ncoastal</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="p">)</span>
<span class="c1"># Concat both models</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">coastal</span><span class="p">,</span> <span class="n">ncoastal</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="3" halign="left">Coastal</th>
      <th colspan="3" halign="left">Non-coastal</th>
    </tr>
    <tr>
      <th></th>
      <th>Coeff.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
      <th>Coeff.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CONSTANT</th>
      <td>4.479904</td>
      <td>0.025094</td>
      <td>0.000000e+00</td>
      <td>4.407242</td>
      <td>0.021516</td>
      <td>0.000000e+00</td>
    </tr>
    <tr>
      <th>accommodates</th>
      <td>0.048464</td>
      <td>0.007881</td>
      <td>8.253761e-10</td>
      <td>0.090186</td>
      <td>0.006474</td>
      <td>1.893020e-43</td>
    </tr>
    <tr>
      <th>bathrooms</th>
      <td>0.247478</td>
      <td>0.016566</td>
      <td>1.381278e-49</td>
      <td>0.143376</td>
      <td>0.014268</td>
      <td>1.418804e-23</td>
    </tr>
    <tr>
      <th>bedrooms</th>
      <td>0.189740</td>
      <td>0.017923</td>
      <td>5.783965e-26</td>
      <td>0.112963</td>
      <td>0.013827</td>
      <td>3.731742e-16</td>
    </tr>
    <tr>
      <th>beds</th>
      <td>-0.050608</td>
      <td>0.010743</td>
      <td>2.522348e-06</td>
      <td>-0.026272</td>
      <td>0.008838</td>
      <td>2.964354e-03</td>
    </tr>
    <tr>
      <th>rt_Private_room</th>
      <td>-0.558628</td>
      <td>0.028312</td>
      <td>4.723759e-84</td>
      <td>-0.529334</td>
      <td>0.018918</td>
      <td>3.546091e-162</td>
    </tr>
    <tr>
      <th>rt_Shared_room</th>
      <td>-1.052854</td>
      <td>0.084174</td>
      <td>1.836512e-35</td>
      <td>-1.224459</td>
      <td>0.042597</td>
      <td>1.657163e-170</td>
    </tr>
    <tr>
      <th>pg_Condominium</th>
      <td>0.204447</td>
      <td>0.033943</td>
      <td>1.810152e-09</td>
      <td>0.105307</td>
      <td>0.028131</td>
      <td>1.831822e-04</td>
    </tr>
    <tr>
      <th>pg_House</th>
      <td>0.075353</td>
      <td>0.023378</td>
      <td>1.274269e-03</td>
      <td>-0.045447</td>
      <td>0.017957</td>
      <td>1.140318e-02</td>
    </tr>
    <tr>
      <th>pg_Other</th>
      <td>0.295485</td>
      <td>0.038645</td>
      <td>2.394157e-14</td>
      <td>0.060753</td>
      <td>0.027637</td>
      <td>2.796727e-02</td>
    </tr>
    <tr>
      <th>pg_Townhouse</th>
      <td>-0.073508</td>
      <td>0.049367</td>
      <td>1.365396e-01</td>
      <td>-0.010397</td>
      <td>0.045673</td>
      <td>8.199294e-01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>An interesting question arises around the relevance of the regimes. <em>Are estimates for each variable across regimes statistically different?</em> For this, the model object also calculates for us what is called a Chow test. This is a statistic that tests the null hypothesis that estimates from different regimes are undistinguishable. If we reject the null, we have evidence suggesting the regimes actually make a difference.</p>
<p>Results from the Chow test are available on the <code class="docutils literal notranslate"><span class="pre">summary</span></code> attribute, or we can extract them directly from the model object, which we will do here. There are two types of Chow test. First is a global one that jointly tests for differences between the two regimes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m5</span><span class="o">.</span><span class="n">chow</span><span class="o">.</span><span class="n">joint</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(328.86902143020575, 7.113548767626822e-64)
</pre></div>
</div>
</div>
</div>
<p>The first value represents the statistic, while the second one captures the p-value. In this case, the two regimes are statistically different from each other. The next step then is to check whether each of the coefficients in our model differs across regimes. For this, we can pull them out into a table:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="c1"># Chow results by variable</span>
    <span class="n">m5</span><span class="o">.</span><span class="n">chow</span><span class="o">.</span><span class="n">regi</span><span class="p">,</span>
    <span class="c1"># Name of variables</span>
    <span class="n">index</span><span class="o">=</span><span class="n">m5</span><span class="o">.</span><span class="n">name_x_r</span><span class="p">,</span>
    <span class="c1"># Column names</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Statistic&quot;</span><span class="p">,</span> <span class="s2">&quot;P-value&quot;</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Statistic</th>
      <th>P-value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CONSTANT</th>
      <td>4.832180</td>
      <td>2.793329e-02</td>
    </tr>
    <tr>
      <th>accommodates</th>
      <td>16.735685</td>
      <td>4.296522e-05</td>
    </tr>
    <tr>
      <th>bathrooms</th>
      <td>22.671471</td>
      <td>1.922004e-06</td>
    </tr>
    <tr>
      <th>bedrooms</th>
      <td>11.503786</td>
      <td>6.945459e-04</td>
    </tr>
    <tr>
      <th>beds</th>
      <td>3.060313</td>
      <td>8.022620e-02</td>
    </tr>
    <tr>
      <th>rt_Private_room</th>
      <td>0.740097</td>
      <td>3.896298e-01</td>
    </tr>
    <tr>
      <th>rt_Shared_room</th>
      <td>3.308838</td>
      <td>6.890820e-02</td>
    </tr>
    <tr>
      <th>pg_Condominium</th>
      <td>5.057283</td>
      <td>2.452265e-02</td>
    </tr>
    <tr>
      <th>pg_House</th>
      <td>16.792503</td>
      <td>4.169771e-05</td>
    </tr>
    <tr>
      <th>pg_Other</th>
      <td>24.409876</td>
      <td>7.786847e-07</td>
    </tr>
    <tr>
      <th>pg_Townhouse</th>
      <td>0.880564</td>
      <td>3.480471e-01</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As we can see in the table, most variables do indeed differ across regimes, statistically speaking. This points to systematic differences in the data generating processes across spatial regimes.</p>
</section>
</section>
<section id="spatial-dependence">
<h3>Spatial dependence<a class="headerlink" href="#spatial-dependence" title="Permalink to this headline">#</a></h3>
<p>As we have just discussed, SH is about effects of phenomena that are <em>explicitly linked</em>
to geography and that hence cause spatial variation and clustering. This
encompasses many of the kinds of spatial effects we may be interested in when we fit
linear regressions. However, in other cases, our focus is on the effect of the <em>spatial
configuration</em> of the observations, and the extent to which that has an effect on the
outcome we are considering. For example, we might think that the price of a house not
only depends on whether it is a townhouse or an apartment, but also on
whether it is surrounded by many more townhouses than skyscrapers with more
apartments. This, we could hypothesize, might be related to the different “look and feel” a
neighborhood with low-height, historic buildings has as compared to one with
modern high-rises. To the extent these two different spatial configurations
enter differently the house price determination process, we will be
interested in capturing not only the characteristics of a house, but also of
its surrounding ones.
This kind of spatial effect is fundamentally different
from SH in that is it not related to inherent characteristics of the geography but relates
to the characteristics of the observations in our dataset and, specially, to their spatial
arrangement. We call this phenomenon by which the values of observations are related to
each other through distance <em>spatial dependence</em> <span id="id3">[<a class="reference internal" href="references.html#id8" title="Luc Anselin. Spatial Econometrics: Methods and Models. Springer Netherlands, 1988. ISBN 9789401577991. URL: http://dx.doi.org/10.1007/978-94-015-7799-1, doi:10.1007/978-94-015-7799-1.">Ans88</a>]</span>.</p>
<p>There are several ways to introduce spatial dependence in an econometric
framework, with varying degrees of econometric sophistication (see
<span id="id4">[<a class="reference internal" href="references.html#id9" title="Luc Anselin. Under the hood issues in the specification and interpretation of spatial regression models. Agricultural Economics, 27(3):247–267, Nov 2002. URL: http://dx.doi.org/10.1111/j.1574-0862.2002.tb00120.x, doi:10.1111/j.1574-0862.2002.tb00120.x.">Ans02</a>]</span> for a good overview). Common to all of them however is the way space is
formally encapsulated: through <em>spatial weights matrices (<span class="math notranslate nohighlight">\(\mathbf{W}\)</span>)</em>, which we discussed in <a class="reference internal" href="04_spatial_weights.html"><span class="doc std std-doc">Chapter 4</span></a>. In this section, we consider three ways in which spatial dependence, through spatial weights matrices, can be incorporated in a regression framework. We begin with the “least invasive” one, where we only modify the set of independent variables, and the move into more substantial modifications of the baseline linear model.</p>
<section id="exogenous-effects-the-slx-model">
<h4>Exogenous effects: The SLX model<a class="headerlink" href="#exogenous-effects-the-slx-model" title="Permalink to this headline">#</a></h4>
<p>Let us come back to the house price example we have been working with. So far, we
have hypothesized that the price of a house rented in San Diego through Airbnb can
be explained using information about its own characteristics as well as some
relating to its location such as the neighborhood or the distance to the main
park in the city. However, it is also reasonable to think that prospective renters
care about the set of neighbors a house has, not only about the house itself, and would
be willing to pay more for a house that was surrounded by certain types of houses,
and less if it was located in the middle of other types. How could we test this idea?</p>
<p>When it comes to regression, the most straightforward way to introduce spatial dependence between the observations in the data is by
considering not only a given explanatory variable, but also its spatial lag. Conceptually, this approach falls more within the area of spatial feature engineering, which embeds space in a model through the explanatory variables it uses rather than the functional form of the model, and which we delve into with more detail in <a class="reference internal" href="12_feature_engineering.html"><span class="doc std std-doc">Chapter 12</span></a>. But we think it is interesting to discuss it in this context for two reasons. First, it provides “intellectual scaffolding” to learn the intuition of building spatial dependence into regression. And second, because it also illustrates how many of the techniques we cover in <a class="reference internal" href="12_feature_engineering.html"><span class="doc std std-doc">Chapter 12</span></a> can be embedded in a regression model (and, by extension, in other predictive approaches).</p>
<p>In our
example case, in addition to including a dummy for the type of house (<code class="docutils literal notranslate"><span class="pre">pg_XXX</span></code>), we
can also include the spatial lag of each type of house. This addition implies
we are also including as explanatory factor of the price of a given house the proportion
neighboring houses in each type. Mathematically, this implies estimating the following model:</p>
<div class="math notranslate nohighlight">
\[
\log(P_i) = \alpha + \sum^{p}_{k=1}X_{ij}\beta_j + \sum^{p}_{k=1}\left(\sum^{N}_{j=1}w_{ij}x_{jk}\right)\gamma_k + \epsilon_i
\]</div>
<p>where <span class="math notranslate nohighlight">\(\sum_{j=1}^N w_{ij}x_{jk}\)</span> represents the spatial lag of the <span class="math notranslate nohighlight">\(k\)</span>th explanatory variable.
This can be stated in <em>matrix</em> form using the spatial weights matrix, <span class="math notranslate nohighlight">\(\mathbf{W}\)</span>, as:</p>
<div class="math notranslate nohighlight">
\[
\log(P_i) = \alpha + \mathbf{X}\beta + \mathbf{WX}\gamma + \epsilon
\]</div>
<p>This splits the model to focus on two main effects: <span class="math notranslate nohighlight">\(\beta\)</span> and <span class="math notranslate nohighlight">\(\gamma\)</span>. The
<span class="math notranslate nohighlight">\(\beta\)</span> effect describes the change in <span class="math notranslate nohighlight">\(y_i\)</span> when <span class="math notranslate nohighlight">\(X_{ik}\)</span> changes by one.
<a class="footnote-reference brackets" href="#elast" id="id5">1</a> The subscript for site <span class="math notranslate nohighlight">\(i\)</span> is important here: since we’re dealing
with a <span class="math notranslate nohighlight">\(\mathbf{W}\)</span> matrix, it’s useful to be clear about where the change occurs.</p>
<p>Indeed, this matters for the <span class="math notranslate nohighlight">\(\gamma\)</span> effect, which represents the
<em>indirect</em> association of a change in <span class="math notranslate nohighlight">\(X_i\)</span> with the house price. This can be conceptualized in two ways.
First, one could think of <span class="math notranslate nohighlight">\(\gamma\)</span> as simply <em>the association between the price in a given house and a unit change in its average surroundings.</em>
This is useful and simple. But this interpretation blurs <em>where</em> this change
might occur. In truth, a change in a variable at site <span class="math notranslate nohighlight">\(i\)</span> will result in a <em>spillover</em> to its surroundings:
when <span class="math notranslate nohighlight">\(x_i\)</span> changes, so too does the <em>spatial lag</em> of any site near <span class="math notranslate nohighlight">\(i\)</span>.
The precise size of the change in the lag will depend on the structure of <span class="math notranslate nohighlight">\(\mathbf{W}\)</span>, and it can be
different for every site it is connected with. For example, think of a very highly connected “focal” site in a
row-standardized weight matrix. This focal site will not be strongly affected
if a neighbor changes by a single unit, since each site only contributes a
small amount to the lag at the focal site. Alternatively, consider a site with only
one neighbor: its lag will change by <em>exactly</em> the amount its sole neighbor changes.
Thus, to discover the exact indirect effect of a change <span class="math notranslate nohighlight">\(y\)</span> caused by the change
at a specific site <span class="math notranslate nohighlight">\(x_i\)</span> you would need to compute the <em>change in the spatial lag</em>,
and then use that as your <em>change</em> in <span class="math notranslate nohighlight">\(X\)</span>. We will discuss this in the following section.</p>
<p>In Python, we can calculate the spatial lag of each variable whose name starts by <code class="docutils literal notranslate"><span class="pre">pg_</span></code>
by first creating a list of all of those names, and then applying <code class="docutils literal notranslate"><span class="pre">pysal</span></code>’s
<code class="docutils literal notranslate"><span class="pre">lag_spatial</span></code> to each of them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select only columns in `db` containing the keyword `pg_`</span>
<span class="n">wx</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">like</span><span class="o">=</span><span class="s2">&quot;pg_&quot;</span>
        <span class="c1"># Compute the spatial lag of each of those variables</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">weights</span><span class="o">.</span><span class="n">spatial_lag</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="c1"># Rename the spatial lag, adding w_ to the original name</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="s2">&quot;w_&quot;</span>
        <span class="o">+</span> <span class="n">c</span>
        <span class="c1"># Remove the lag of the binary variable for apartments</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;w_pg_Apartment&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Once computed, we can run the model using OLS estimation because, in this
context, the spatial  lags included do not violate any of the assumptions OLS
relies on (they are essentially additional exogenous variables):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Merge original variables with the spatial lags in `wx`</span>
<span class="n">slx_exog</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wx</span><span class="p">)</span>
<span class="c1"># Fit linear model with `spreg`</span>
<span class="n">m6</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span>
    <span class="c1"># Dependent variable</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Independent variables</span>
    <span class="n">slx_exog</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Dependent variable name</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;l_price&quot;</span><span class="p">,</span>
    <span class="c1"># Independent variables names</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">slx_exog</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>As in the previous cases, printing the <code class="docutils literal notranslate"><span class="pre">summary</span></code> attribute of the model object would show a full report table. The variables we included in the original regression
display similar behavior, albeit with small changes in size, and can be
interpreted also in a similar way. To focus on the aspects that differ from the previous models here, we will only pull out results for the variables for which we also included their spatial lags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Collect names of variables of interest</span>
<span class="n">vars_of_interest</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">like</span><span class="o">=</span><span class="s2">&quot;pg_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wx</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
<span class="p">)</span>
<span class="c1"># Build full table of regression coefficients</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="c1"># Pull out regression coefficients and</span>
        <span class="c1"># flatten as they are returned as Nx1 array</span>
        <span class="s2">&quot;Coeff.&quot;</span><span class="p">:</span> <span class="n">m6</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out and flatten standard errors</span>
        <span class="s2">&quot;Std. Error&quot;</span><span class="p">:</span> <span class="n">m6</span><span class="o">.</span><span class="n">std_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out P-values from t-stat object</span>
        <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m6</span><span class="o">.</span><span class="n">t_stat</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="n">m6</span><span class="o">.</span><span class="n">name_x</span>
    <span class="c1"># Subset for variables of interest only and round to</span>
    <span class="c1"># four decimals</span>
<span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">vars_of_interest</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coeff.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>pg_Condominium</th>
      <td>0.1063</td>
      <td>0.0222</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>pg_House</th>
      <td>0.0328</td>
      <td>0.0157</td>
      <td>0.0368</td>
    </tr>
    <tr>
      <th>pg_Other</th>
      <td>0.0862</td>
      <td>0.0240</td>
      <td>0.0003</td>
    </tr>
    <tr>
      <th>pg_Townhouse</th>
      <td>-0.0277</td>
      <td>0.0338</td>
      <td>0.4130</td>
    </tr>
    <tr>
      <th>w_pg_Condominium</th>
      <td>0.5928</td>
      <td>0.0690</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>w_pg_House</th>
      <td>-0.0774</td>
      <td>0.0319</td>
      <td>0.0152</td>
    </tr>
    <tr>
      <th>w_pg_Other</th>
      <td>0.4851</td>
      <td>0.0551</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>w_pg_Townhouse</th>
      <td>-0.2724</td>
      <td>0.1223</td>
      <td>0.0260</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The spatial lag of each type of property
(<code class="docutils literal notranslate"><span class="pre">w_pg_XXX</span></code>) is the new addition. We observe that, except for the case
of townhouses (same as with the binary variable, <code class="docutils literal notranslate"><span class="pre">pg_Townhouse</span></code>), they are all
significant, suggesting our initial hypothesis on the role of the surrounding
houses might indeed be at work here.</p>
<p>As an illustration, let’s look at some of the direct/indirect effects.
The direct effect of the <code class="docutils literal notranslate"><span class="pre">pg_Condominium</span></code> variable means that condominiums are
typically 11% more expensive (<span class="math notranslate nohighlight">\(\beta_{pg\_{Condominium}}=0.1063\)</span>) than the benchmark
property type, apartments. More relevant to this section, any given house surrounded by
condominiums <em>also</em> receives a price premium. But, since <span class="math notranslate nohighlight">\(pg_{Condominium}\)</span> is a dummy variable,
the spatial lag at site <span class="math notranslate nohighlight">\(i\)</span> represents the <em>percentage</em> of properties near <span class="math notranslate nohighlight">\(i\)</span> that are
condominiums, which is between <span class="math notranslate nohighlight">\(0\)</span> and <span class="math notranslate nohighlight">\(1\)</span>.<a class="footnote-reference brackets" href="#discover" id="id6">2</a>
So, a <em>unit</em> change in this variable means that you would increase the condominium
percentage by 100%. Thus, a <span class="math notranslate nohighlight">\(.1\)</span> increase in <code class="docutils literal notranslate"><span class="pre">w_pg_Condominium</span></code> (a change of ten percentage points)
would result in a 5.92% increase in the property house price (<span class="math notranslate nohighlight">\(\beta_{w_pg\_Condominium} = 0.6\)</span>).
Similar interpretations can be derived for all other spatially lagged variables to derive the
<em>indirect</em> effect of a change in the spatial lag.</p>
<p>To compute the indirect change for a given site <span class="math notranslate nohighlight">\(i\)</span>, you may need to examine the predicted values for its price. In this example, since we are using a row-standardized weights matrix with twenty nearest neighbors, the impact of changing <span class="math notranslate nohighlight">\(x_i\)</span> is the same for all of its neighbors and for any site <span class="math notranslate nohighlight">\(i\)</span>. Thus, the effect is always <span class="math notranslate nohighlight">\(\frac{\gamma}{20}\)</span>, or about <span class="math notranslate nohighlight">\(0.0296\)</span>. However, it is interesting to consider this would not be the case for many other kinds of weights (like <code class="docutils literal notranslate"><span class="pre">Kernel</span></code>, <code class="docutils literal notranslate"><span class="pre">Queen</span></code>, <code class="docutils literal notranslate"><span class="pre">Rook</span></code>, <code class="docutils literal notranslate"><span class="pre">DistanceBand</span></code>, or <code class="docutils literal notranslate"><span class="pre">Voronoi</span></code>), where each observation has potentially a different number of neighbors. To illustrate this, we will construct the indirect effect for a specific <span class="math notranslate nohighlight">\(i\)</span> in the condominium group.</p>
<p>First, predicted values for <span class="math notranslate nohighlight">\(y_i\)</span> are stored in the <code class="docutils literal notranslate"><span class="pre">predy</span></code> attribute of any <code class="docutils literal notranslate"><span class="pre">spreg</span></code> model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print first three predicted values</span>
<span class="n">m5</span><span class="o">.</span><span class="n">predy</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[5.27285901],
       [5.39966259],
       [4.28834686]])
</pre></div>
</div>
</div>
</div>
<p>To build new predictions, we need to follow the underlying equation of our model.</p>
<p>To illustrate the effect of a change in one of the values in a given location in other locations, we will switch one of the properties into the condominium category. Consider the third observation, which is the first apartment in the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Print values for third observation for columns spanning</span>
<span class="c1"># from `pg_Apartment` to `pg_Townhouse`</span>
<span class="n">db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pg_Apartment&quot;</span><span class="p">:</span><span class="s2">&quot;pg_Townhouse&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pg_Apartment      1
pg_Condominium    0
pg_House          0
pg_Other          0
pg_Townhouse      0
Name: 2, dtype: object
</pre></div>
</div>
</div>
</div>
<p>Let’s now make a copy of our data and change the value to magically turn the apartment into a condominium:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make copy of the dataset</span>
<span class="n">db_scenario</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># Make Apartment 0 and condo 1 for third observation</span>
<span class="n">db_scenario</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;pg_Apartment&quot;</span><span class="p">,</span> <span class="s2">&quot;pg_Condominium&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We’ve successfully made the change:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">db_scenario</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;pg_Apartment&quot;</span><span class="p">:</span><span class="s2">&quot;pg_Townhouse&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pg_Apartment      0
pg_Condominium    1
pg_House          0
pg_Other          0
pg_Townhouse      0
Name: 2, dtype: object
</pre></div>
</div>
</div>
</div>
<p>Now, we need to <em>also</em> update the spatial lag variates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Select only columns in `db_scenario` containing the keyword `pg_`</span>
<span class="n">wx_scenario</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">db_scenario</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
        <span class="n">like</span><span class="o">=</span><span class="s2">&quot;pg&quot;</span>
        <span class="c1"># Compute the spatial lag of each of those variables</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="n">weights</span><span class="o">.</span><span class="n">spatial_lag</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="c1"># Rename the spatial lag, adding w_ to the original name</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="n">columns</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="s2">&quot;w_&quot;</span>
        <span class="o">+</span> <span class="n">c</span>
        <span class="c1"># Remove the lag of the binary variable for apartments</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;w_pg_Apartment&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And build a new exogenous <span class="math notranslate nohighlight">\(\mathbf{X}\)</span> matrix, including the a constant 1 as the leading column</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slx_exog_scenario</span> <span class="o">=</span> <span class="n">db_scenario</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">wx_scenario</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, our new prediction (in the scenario where we have changed site <code class="docutils literal notranslate"><span class="pre">2</span></code> from an apartment into a condominium) can be computed by translating the model equation into Python code and plugging into it the simulated values we have just created:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compute new set of predicted values</span>
<span class="n">y_pred_scenario</span> <span class="o">=</span> <span class="n">m6</span><span class="o">.</span><span class="n">betas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">slx_exog_scenario</span> <span class="o">@</span> <span class="n">m6</span><span class="o">.</span><span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
</div>
<p>Note the only difference between this set of predictions and the one in the original <code class="docutils literal notranslate"><span class="pre">m6</span></code> model is that we have switched site <code class="docutils literal notranslate"><span class="pre">2</span></code> from apartment into condominium. Hence, every property which is <em>not</em> connected to site <code class="docutils literal notranslate"><span class="pre">2</span></code> (or is not site <code class="docutils literal notranslate"><span class="pre">2</span></code> itself) will be unaffected. The <em>neighbors</em> of site <code class="docutils literal notranslate"><span class="pre">2</span></code> however will have different predictions. To explore these, let’s first identify who is in this group:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">knn</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[772, 2212, 139, 4653, 2786, 1218, 138, 808, 1480, 4241, 1631, 3617, 2612, 1162, 135, 23, 5528, 3591, 407, 6088]
</pre></div>
</div>
</div>
</div>
<p>Now, the effect of changing site <code class="docutils literal notranslate"><span class="pre">2</span></code> from an apartment into a condominium is associated with the following changes to the predicted (log) price, which we calculate by substracting the new predicted values from the original ones and subsetting only to site <code class="docutils literal notranslate"><span class="pre">2</span></code> and its neighbors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Difference between original and new predicted values</span>
<span class="p">(</span>
    <span class="n">y_pred_scenario</span>
    <span class="o">-</span> <span class="n">m6</span><span class="o">.</span><span class="n">predy</span>
    <span class="c1"># Subset to site `2` and its neighbors</span>
<span class="p">)</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">knn</span><span class="o">.</span><span class="n">neighbors</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2</th>
      <td>0.106349</td>
    </tr>
    <tr>
      <th>772</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>2212</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>139</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>4653</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>2786</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>1218</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>138</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>808</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>1480</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>4241</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>1631</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>3617</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>2612</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>1162</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>135</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>23</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>5528</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>3591</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>407</th>
      <td>0.029642</td>
    </tr>
    <tr>
      <th>6088</th>
      <td>0.029642</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We see the first row, representing the direct effect, is equal exactly to the estimate for <code class="docutils literal notranslate"><span class="pre">pg_Condominium</span></code>. For the other effects, though, we have only changed <code class="docutils literal notranslate"><span class="pre">w_pg_Condominium</span></code> by <span class="math notranslate nohighlight">\(.03\)</span> which roughly equates the marginal effect (<code class="docutils literal notranslate"><span class="pre">w_pg_Condominium</span></code>) divided by the weight of the spatial relationship between site <code class="docutils literal notranslate"><span class="pre">2</span></code> and every neighbor (in this case, <span class="math notranslate nohighlight">\(\frac{1}{20}\)</span> for every neighbor, but note if different neighbors had different cardinalities, this would differ).</p>
<p>Introducing a spatial lag of an explanatory variable, as we have just seen, is the most straightforward way of incorporating the notion of spatial dependence in a linear regression framework. It does not require additional changes, it can be estimated with OLS, and the interpretation is rather similar to interpreting non-spatial variables, so long as aggregate changes are required.</p>
<p>The field of spatial econometrics however is a much broader one and has produced over the last decades many techniques to deal with spatial effects and spatial dependence in different ways. Although this might be an over-simplification, one can say that most of such efforts for the case of a single cross-section are focused on two main variations: the spatial lag and the spatial error model. Both are similar to the case we have seen in that they are based on the introduction of a spatial lag, but they differ in the component of the model they modify and affect.</p>
</section>
<section id="spatial-error">
<h4>Spatial error<a class="headerlink" href="#spatial-error" title="Permalink to this headline">#</a></h4>
<p>The spatial error model includes a spatial lag in the <em>error</em> term of the equation:</p>
<div class="math notranslate nohighlight">
\[
\log{P_i} = \alpha + \sum_k \beta_k X_{ki} + u_i
\]</div>
<div class="math notranslate nohighlight">
\[
u_i = \lambda u_{lag-i} + \epsilon_i
\]</div>
<p>where <span class="math notranslate nohighlight">\(u_{lag-i} = \sum_j w_{i,j} u_j\)</span>.
Although it appears similar, this specification violates the assumptions about the
error term in a classical OLS model. Hence, alternative estimation methods are
required. Pysal incorporates functionality to estimate several of the most
advanced techniques developed by the literature on spatial econometrics. For
example, we can use a general method of moments that account for
heteroskedasticity <span id="id7">[<a class="reference internal" href="references.html#id7" title="Irani Arraiz, David M. Drukker, Harry H. Kelejian, and Ingmar R. Prucha. A spatial Cliff-Ord-type model with heteroskedastic innovations: Small and large sample results. Journal of Regional Science, 50(2):592–614, 2010.">ADKP10</a>]</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit spatial error model with `spreg`</span>
<span class="c1"># (GMM estimation allowing for heteroskedasticity)</span>
<span class="n">m7</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">GM_Error_Het</span><span class="p">(</span>
    <span class="c1"># Dependent variable</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Independent variables</span>
    <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Spatial weights matrix</span>
    <span class="n">w</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span>
    <span class="c1"># Dependent variable name</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;log_price&quot;</span><span class="p">,</span>
    <span class="c1"># Independent variables names</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">variable_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Similarly as before, the <code class="docutils literal notranslate"><span class="pre">summary</span></code> attribute will return a full-featured table of results. For the most part, it may be interpreted in similar ways to those above. The main difference is that, in this case, we can also recover an estimate and inference for the <span class="math notranslate nohighlight">\(\lambda\)</span> parameter in the error term:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build full table of regression coefficients</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="c1"># Pull out regression coefficients and</span>
        <span class="c1"># flatten as they are returned as Nx1 array</span>
        <span class="s2">&quot;Coeff.&quot;</span><span class="p">:</span> <span class="n">m7</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out and flatten standard errors</span>
        <span class="s2">&quot;Std. Error&quot;</span><span class="p">:</span> <span class="n">m7</span><span class="o">.</span><span class="n">std_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out P-values from t-stat object</span>
        <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m7</span><span class="o">.</span><span class="n">z_stat</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="n">m7</span><span class="o">.</span><span class="n">name_x</span>
    <span class="c1"># Subset for lambda parameter and round to</span>
    <span class="c1"># four decimals</span>
<span class="p">)</span><span class="o">.</span><span class="n">reindex</span><span class="p">([</span><span class="s2">&quot;lambda&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coeff.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>lambda</th>
      <td>0.6449</td>
      <td>0.0187</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="spatial-lag">
<h4>Spatial lag<a class="headerlink" href="#spatial-lag" title="Permalink to this headline">#</a></h4>
<p>The spatial lag model introduces a spatial lag of the <em>dependent</em> variable. In the example we have covered, this would translate into:</p>
<div class="math notranslate nohighlight">
\[
\log{P_i} = \alpha + \rho \log{P_{lag-i}} + \sum_k \beta_k X_{ki} + \epsilon_i
\]</div>
<p>Although it might not seem very different from the previous equation, this model violates
the exogeneity assumption, crucial for OLS to work.
Put simply, this occurs when <span class="math notranslate nohighlight">\(P_i\)</span> exists on both “sides” of the equals sign.
In theory, since <span class="math notranslate nohighlight">\(P_i\)</span> is included in computing <span class="math notranslate nohighlight">\(P_{lag-i}\)</span>, exogeneity is violated.
Similarly to the case of
the spatial error, several techniques have been proposed to overcome this
limitation, and Pysal implements several of them. In the example below, we
use a two-stage least squares estimation <span id="id8">[<a class="reference internal" href="references.html#id8" title="Luc Anselin. Spatial Econometrics: Methods and Models. Springer Netherlands, 1988. ISBN 9789401577991. URL: http://dx.doi.org/10.1007/978-94-015-7799-1, doi:10.1007/978-94-015-7799-1.">Ans88</a>]</span>, where the spatial
lag of all the explanatory variables is used as instrument for the endogenous
lag:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fit spatial lag model with `spreg`</span>
<span class="c1"># (GMM estimation)</span>
<span class="n">m8</span> <span class="o">=</span> <span class="n">spreg</span><span class="o">.</span><span class="n">GM_Lag</span><span class="p">(</span>
    <span class="c1"># Dependent variable</span>
    <span class="n">db</span><span class="p">[[</span><span class="s2">&quot;log_price&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Independent variables</span>
    <span class="n">db</span><span class="p">[</span><span class="n">variable_names</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="c1"># Spatial weights matrix</span>
    <span class="n">w</span><span class="o">=</span><span class="n">knn</span><span class="p">,</span>
    <span class="c1"># Dependent variable name</span>
    <span class="n">name_y</span><span class="o">=</span><span class="s2">&quot;log_price&quot;</span><span class="p">,</span>
    <span class="c1"># Independent variables names</span>
    <span class="n">name_x</span><span class="o">=</span><span class="n">variable_names</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And let’s summarize the coefficients in a table as before (usual disclaimer about the <code class="docutils literal notranslate"><span class="pre">summary</span></code> object applies):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Build full table of regression coefficients</span>
<span class="n">pandas</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="c1"># Pull out regression coefficients and</span>
        <span class="c1"># flatten as they are returned as Nx1 array</span>
        <span class="s2">&quot;Coeff.&quot;</span><span class="p">:</span> <span class="n">m8</span><span class="o">.</span><span class="n">betas</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out and flatten standard errors</span>
        <span class="s2">&quot;Std. Error&quot;</span><span class="p">:</span> <span class="n">m8</span><span class="o">.</span><span class="n">std_err</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
        <span class="c1"># Pull out P-values from t-stat object</span>
        <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">m8</span><span class="o">.</span><span class="n">z_stat</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="n">index</span><span class="o">=</span><span class="n">m8</span><span class="o">.</span><span class="n">name_z</span>
    <span class="c1"># Round to four decimals</span>
<span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Coeff.</th>
      <th>Std. Error</th>
      <th>P-Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>CONSTANT</th>
      <td>2.7440</td>
      <td>0.0727</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>accommodates</th>
      <td>0.0698</td>
      <td>0.0048</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>bathrooms</th>
      <td>0.1627</td>
      <td>0.0104</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>bedrooms</th>
      <td>0.1604</td>
      <td>0.0105</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>beds</th>
      <td>-0.0365</td>
      <td>0.0065</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>rt_Private_room</th>
      <td>-0.4981</td>
      <td>0.0151</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>rt_Shared_room</th>
      <td>-1.1157</td>
      <td>0.0366</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>pg_Condominium</th>
      <td>0.1073</td>
      <td>0.0209</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>pg_House</th>
      <td>-0.0004</td>
      <td>0.0137</td>
      <td>0.9766</td>
    </tr>
    <tr>
      <th>pg_Other</th>
      <td>0.1208</td>
      <td>0.0215</td>
      <td>0.0000</td>
    </tr>
    <tr>
      <th>pg_Townhouse</th>
      <td>-0.0186</td>
      <td>0.0323</td>
      <td>0.5653</td>
    </tr>
    <tr>
      <th>W_log_price</th>
      <td>0.3416</td>
      <td>0.0148</td>
      <td>0.0000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Similarly to the effects in the SLX regression, changes in the spatial lag regression need to be interpreted with care. Here, <code class="docutils literal notranslate"><span class="pre">W_log_price</span></code> applies consistently over all observations and actually changes the effective strength of each of the <span class="math notranslate nohighlight">\(\beta\)</span> coefficients. Thus, it is useful to use predictions and scenario-building to predict <span class="math notranslate nohighlight">\(y\)</span> when changing <span class="math notranslate nohighlight">\(X\)</span>, which allows you to analyze the <em>direct</em> and <em>indirect</em> components.</p>
</section>
<section id="other-ways-of-bringing-space-into-regression">
<h4>Other ways of bringing space into regression<a class="headerlink" href="#other-ways-of-bringing-space-into-regression" title="Permalink to this headline">#</a></h4>
<p>We have covered here only a few ways to formally introduce space in a regression framework. There are however many other advanced spatial regression methods routinely used in statistics, data science, and applied analysis. For example, Generalized Additive Models <span id="id9">[<a class="reference internal" href="references.html#id29" title="Steve Gibbons, Henry G. Overman, and Eleonora Patacchini. Spatial methods. Handbook of Regional and Urban Economics, pages 115–168, 2015. URL: http://dx.doi.org/10.1016/b978-0-444-59517-1.00003-9, doi:10.1016/b978-0-444-59517-1.00003-9.">GOP15</a>, <a class="reference internal" href="references.html#id57" title="Simon N. Wood. Generalized Additive Models. Chapman and Hall/CRC, Feb 2006. ISBN 9781420010404. URL: http://dx.doi.org/10.1201/9781420010404, doi:10.1201/9781420010404.">Woo06</a>]</span> have been used to apply spatial kernel smoothing directly within a regression function. Other similar smoothing methods, such as spatial Gaussian Process Models <span id="id10">[<a class="reference internal" href="references.html#id17" title="Chris Brunsdon, A. Stewart Fotheringham, and Martin E. Charlton. Geographically weighted regression: a method for exploring spatial nonstationarity. Geographical Analysis, 28(4):281–298, Sep 2010. URL: http://dx.doi.org/10.1111/j.1538-4632.1996.tb00936.x, doi:10.1111/j.1538-4632.1996.tb00936.x.">BFC10</a>]</span> or Kriging, conceptualize the dependence between locations as smooth as well. Other methods in spatial regression that consider graph-based geographies (rather than distance/kernel effects) include variations on conditional autoregressive model, which examines spatial relationships at locations <em>conditional</em> on their surroundings, rather than as jointly co-emergent with them. Full coverage of these topics is beyond the scope of this book, however, though <span id="id11">[<a class="reference internal" href="references.html#id13" title="Sudipto Banerjee, Alan E. Gelfand, Andrew O. Finley, and Huiyan Sang. Gaussian predictive process models for large spatial data sets. Journal of the Royal Statistical Society: Series B (Statistical Methodology), 70(4):825–848, Sep 2008. URL: http://dx.doi.org/10.1111/j.1467-9868.2008.00663.x, doi:10.1111/j.1467-9868.2008.00663.x.">BGFS08</a>]</span> provides a detailed and comprehensive discussion. We have not covered these (and other existing ones) not because we do not think are important or useful, far from it, but because we consider them a bit more advanced than the level at which we wanted to pitch the chapter.</p>
<p>Both sets of models we have introduced in here and others that exist but that we have not covered share the feature of embedding space as a “first class” citizen in the regression framework. In all these cases, we conceptualize space (e.g., through a spatial weights matrix) and <em>modify</em> the functional form of our original model in a way that recognizes the location of its observations when generating predictions or inference. This approach results in modifications of the modeling framework to accommodate geography. In the next chapter, we discuss a different perspective to embed space in our modeling efforts. Rather than injecting space through the functional form, we will do it through the variables we use to explain/predict the outcome of interest. In this case, we will be using geography to <em>enrich</em> our data <em>before</em> it is passed through a modeling framework.</p>
</section>
</section>
</section>
<section id="questions">
<h2>Questions<a class="headerlink" href="#questions" title="Permalink to this headline">#</a></h2>
<ol class="arabic simple">
<li><p>One common kind of spatial econometric model is the “Spatial Durbin Model,” which combines the SLX model with the spatial lag model. Alternatively, the “Spatial Durbin Error Model” combines the SLX model with the spatial error model. Fit a Spatial Durbin variant of the spatial models we have fit in this chapter.</p>
<ul class="simple">
<li><p>Do these variants improve the model fit?</p></li>
<li><p>What happens to the spatial autocorrelation parameters (<span class="math notranslate nohighlight">\(\rho\)</span>, <span class="math notranslate nohighlight">\(\lambda\)</span>) when the SLX term is added? Why might this occur?</p></li>
</ul>
</li>
<li><p>Fortunately for us, spatial error models recover the same estimates (asymptotically) as a typical OLS estimate, although their confidence intervals will change. Statistically, this occurs because OLS miscalculates when there is spatial correlation and/or spatial heteroskedasticity. How much do the confidence intervals change when the spatial error model is fit?</p></li>
<li><p>One common justification for the SLX model (and the Spatial Durbin variants) is about <em>omitted, spatially patterned variables</em>. That is, if an omitted variable is associated with the included variables <em>and</em> is spatially patterned, then we can use the spatial structure of our existing variables to mimic the omitted variable. In our spatial lag model,</p>
<ul class="simple">
<li><p>what variables might we be missing that are important to predict the price of an Airbnb?</p></li>
<li><p>would these omitted variables have a similar spatial pattern to our included variables? Why or why not?</p></li>
</ul>
</li>
<li><p>Where <em>spatial</em> regression models generally focus on how nearby observations are similar to one another, <em>platial</em> models focus on how observations in the same spatial group are similar to one another. These are often dealt with using multi-level or spatial mixed-effect models. When do these two ideas work together well? And, when might these disagree?</p></li>
</ol>
<section id="challenge-questions">
<h3>Challenge questions<a class="headerlink" href="#challenge-questions" title="Permalink to this headline">#</a></h3>
<p>The following discussions are a bit challenging but reflect extra enhancements to the discussions in the chapter that may solidify or enhance an advanced understanding of the material.</p>
<section id="the-random-coast">
<h4>The random coast<a class="headerlink" href="#the-random-coast" title="Permalink to this headline">#</a></h4>
<p>In the section analyzing our naive model residuals, we ran a classic two-sample <span class="math notranslate nohighlight">\(t\)</span>-test to identify whether or not our coastal and non-coastal residential districts tended to have the same prediction errors. Often, though, it’s better to use straightforward, data-driven testing and simulation methods than assuming that the mathematical assumptions of the <span class="math notranslate nohighlight">\(t\)</span>-statistic are met.</p>
<p>To do this, we can shuffle our assignments to coast and not-coast, and check whether or not there are differences in the distributions of the <em>observed</em> residual distributions and random distributions. In this way, we shuffle the observations that are on the coast, and plot the resulting cumulative distributions.</p>
<p>Below, we run 100 simulated re-assignments of districts to either “coast” or “not coast,” and compare the distributions of randomly assigned residuals to the observed distributions of residuals. Further, we do this plotting by the <em>empirical cumulative density function</em>, not the histogram directly. This is because the <em>empirical cumulative density function</em> is usually easier to examine visually, especially for subtle differences.</p>
<p>The black lines in Figure XXX8XXX represent our simulations, and the colored patches below them represent the observed distribution of residuals. If the black lines tend to be on the left of the colored patch, then, the simulations (where prediction error is totally random with respect to our categories of “coastal” and “not coastal”) tend to have more negative residuals than our actual model. If the black lines tend to be on the right, then they tend to have more positive residuals. As a refresher, positive residuals mean that our model is under-predicting, and negative residuals mean that our model is over-predicting. Below, our simulations provide direct evidence for the claim that our model may be systematically under-predicting coastal price and over-predicting non-coastal prices.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_simulations</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">coastal</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Coastal&quot;</span><span class="p">,</span>
    <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">not_coastal</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
    <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Not Coastal&quot;</span><span class="p">,</span>
    <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">simulation</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_simulations</span><span class="p">):</span>
    <span class="n">shuffled_residuals</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">random_coast</span><span class="p">,</span> <span class="n">random_notcoast</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">shuffled_residuals</span><span class="p">[</span><span class="n">is_coastal</span><span class="p">],</span>
        <span class="n">shuffled_residuals</span><span class="p">[</span><span class="o">~</span><span class="n">is_coastal</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">simulation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Simulations&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">random_coast</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">random_coast</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;step&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">cumulative</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3e6fe70b6713c1a9b59c4798fe1697edfc82720f92fca60f78552d592d6cef00.png" src="../_images/3e6fe70b6713c1a9b59c4798fe1697edfc82720f92fca60f78552d592d6cef00.png" />
</div>
</div>
</section>
<section id="the-k-neighbor-correlogram">
<h4>The K-neighbor correlogram<a class="headerlink" href="#the-k-neighbor-correlogram" title="Permalink to this headline">#</a></h4>
<p>Further, it might be the case that spatial dependence in our mispredictions only matters for sites that are extremely close to one another, and it decays quickly with distance.
To investigate this, we can examine the correlation between each site’s residual and the <em>average</em> of the <span class="math notranslate nohighlight">\(k\)</span>th nearest neighbors’ residuals, increasing <span class="math notranslate nohighlight">\(k\)</span> until the estimate stabilizes.
This main idea is central to the geostatistical concept, the <em>correlogram</em>, which gives the correlation between sites of an attribute being studied as distance increases.</p>
<p>One quick way to check whether or not what we’ve seen is <em>unique</em> or <em>significant</em> is to compare it to what happens when we just assign neighbors randomly.
If what we observe is substantially different from what emerges when neighbors are random, then the structure of the neighbors embeds a structure in the residuals.
We won’t spend too much time on this theory specifically, but we can quickly and efficiently compute the correlation between our observed residuals and the spatial lag of an increasing <span class="math notranslate nohighlight">\(k\)</span>-nearest neighbor set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">correlations</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">nulls</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="n">knn</span><span class="o">.</span><span class="n">reweight</span><span class="p">(</span>
        <span class="n">k</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>  <span class="c1"># operates in place, quickly and efficiently avoiding copies</span>
    <span class="n">knn</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span>
    <span class="n">lag_residual</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">spatial_lag</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">)</span>
    <span class="n">random_residual</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="p">))]</span>
    <span class="n">random_lag_residual</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">spatial_lag</span><span class="o">.</span><span class="n">lag_spatial</span><span class="p">(</span>
        <span class="n">knn</span><span class="p">,</span> <span class="n">random_residual</span>
    <span class="p">)</span>  <span class="c1"># identical to random neighbors in KNN</span>
    <span class="n">correlations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lag_residual</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">nulls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">m1</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">random_lag_residual</span><span class="o">.</span><span class="n">flatten</span><span class="p">())[</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>
        <span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And use the code below to generate Figure XXX9XXX:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">correlations</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">nulls</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orangered&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]),</span>
    <span class="o">*</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span>
    <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nulls</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]),</span> <span class="o">*</span><span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">s</span><span class="o">=</span><span class="s2">&quot;Long-Run Correlation: $</span><span class="si">{:.2f}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">correlations</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
    <span class="p">),</span>
    <span class="n">x</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
    <span class="n">s</span><span class="o">=</span><span class="s2">&quot;Long-Run Null: $</span><span class="si">{:.2f}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">nulls</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])),</span>
    <span class="n">x</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$K$: number of nearest neighbors&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span>
    <span class="s2">&quot;Correlation between site </span><span class="se">\n</span><span class="s2"> and neighborhood average of size $K$&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7db8b2e55acfe91bc209666348ae4ed23f5ee236aa7bae69642580462e768291.png" src="../_images/7db8b2e55acfe91bc209666348ae4ed23f5ee236aa7bae69642580462e768291.png" />
</div>
</div>
<p>Clearly, the two curves are different. The observed correlation reaches a peak around <span class="math notranslate nohighlight">\(r=.34\)</span> when around 20 nearest listings are used. This means that adding more than 20 nearest neighbors does not significantly change the correlation in the residuals. Further, the lowest correlation is for the single nearest neighbor, and correlation rapidly increases as more neighbors are added close to the listing. Thus, this means that there does appear to be an unmeasured spatial structure in the residuals, since they are more similar to one another when they are near than when they are far apart. Further, while it’s not shown here (since computationally, it becomes intractable), as the number of nearest neighbors gets very large (approaching the number of observations in the dataset), the average of the <span class="math notranslate nohighlight">\(k\)</span>th nearest neighbors’ residuals goes to zero, the global average of residuals. This means that the correlation of the residuals and a vector that is nearly constant begins to approach zero.</p>
<p>The null correlations, however, use randomly chosen neighbors (without reassignment).
Thus, since sampling is truly random in this case, each average of <span class="math notranslate nohighlight">\(k\)</span> randomly chosen neighbors is usually zero (global mean).
So, the correlation between the observed residual and the average of <span class="math notranslate nohighlight">\(k\)</span> randomly chosen residuals is also usually zero.
Thus, increasing the number of randomly chosen neighbors does not significantly adjust the long-run average of zero.
Taken together, we can conclude that there is distinct positive spatial dependence in the error.
This means that our over- and under-predictions are likely to cluster.</p>
</section>
</section>
</section>
<section id="next-steps">
<h2>Next steps<a class="headerlink" href="#next-steps" title="Permalink to this headline">#</a></h2>
<p>For additional reading on the topics covered in this chapter, please consult the following resources:</p>
<p>For a more in-depth discussion of the fundamentals of spatial econometrics and applications in both GUI and command-line software, consult:</p>
<p>Anselin, Luc and Sergio Rey. 2014. <em>Modern Spatial Econometrics in Practice: A Guide to GeoDa, GeoDaSpace, and Pysal.</em> GeoDa Press.</p>
<p>For additional mathematical detail and more extensive treatment of space-time models, consult:</p>
<p>Cressie, Noel and Christopher N. Wikle. 2011. <em>Statistics for Spatio-Temporal Data</em>. Singapore: Wiley Press.</p>
<p>For an alternative perspective on regression and critique of the spatial econometric perspective, consider:</p>
<p>Gibbons, Stephen and Henry G. Overman. 2012. “Mostly Pointless Spatial Econometrics.” <em>Journal of Regional Science</em> 52: 172-191.</p>
<p>And for a useful overview of the discussions around multi-level modeling, with references therein to further resources, consider:</p>
<p>Owen, Gwilym, Richard Harris, and Kelvyn Jones. “Under Examination: Multilevel models, geography and health research.” <em>Progress in Human Geography</em> 40(3): 394-412.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="elast"><span class="brackets"><a class="fn-backref" href="#id5">1</a></span></dt>
<dd><p>Since we use the log price as the dependent variable, our
<span class="math notranslate nohighlight">\(\beta\)</span> coefficients can be interpreted as the percentage change in the price associated with a unit change in the explanatory variable.</p>
</dd>
<dt class="label" id="discover"><span class="brackets"><a class="fn-backref" href="#id6">2</a></span></dt>
<dd><p>Discover this for yourself: what is the average of <code class="docutils literal notranslate"><span class="pre">numpy.array([True,</span> <span class="pre">True,</span> <span class="pre">True,</span> <span class="pre">False,</span> <span class="pre">False,</span> <span class="pre">True)]</span></code>?</p>
</dd>
</dl>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="10_clustering_and_regionalization.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Clustering and Regionalization</p>
      </div>
    </a>
    <a class="right-next"
       href="12_feature_engineering.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Spatial Feature Engineering</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-spatial-regression-and-why-should-i-care"><em>What</em> is spatial regression and <em>why</em> should I care?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-san-diego-airbnb">Data: San Diego Airbnb</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#non-spatial-regression-a-very-quick-refresh">Non-spatial regression, a (very) quick refresh</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hidden-structures">Hidden structures</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#bringing-space-into-the-regression-framework">Bringing space into the regression framework</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-feature-engineering-proximity-variables">Spatial feature engineering: proximity variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-heterogeneity">Spatial heterogeneity</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-fixed-effects">Spatial fixed effects</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-regimes">Spatial regimes</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-dependence">Spatial dependence</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#exogenous-effects-the-slx-model">Exogenous effects: The SLX model</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-error">Spatial error</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#spatial-lag">Spatial lag</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#other-ways-of-bringing-space-into-regression">Other ways of bringing space into regression</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#questions">Questions</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#challenge-questions">Challenge questions</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-random-coast">The random coast</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#the-k-neighbor-correlogram">The K-neighbor correlogram</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#next-steps">Next steps</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Sergio J. Rey, Dani Arribas-Bel, Levi J. Wolf
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2020.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/">Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 International License</a>.

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>